name: å°è‚¡åˆ†ææ©Ÿå™¨äºº

on:
  schedule:
    # æ—©ç›¤æƒæ - å·¥ä½œæ—¥ 09:00 å°åŒ—æ™‚é–“
    - cron: '0 1 * * 1-5'
    # ç›¤å¾Œæƒæ - å·¥ä½œæ—¥ 15:00 å°åŒ—æ™‚é–“  
    - cron: '0 7 * * 1-5'
    # å¿ƒè·³æª¢æ¸¬ - æ¯æ—¥ 08:30 å°åŒ—æ™‚é–“
    - cron: '30 0 * * *'
  
  workflow_dispatch:
    inputs:
      analysis_type:
        description: 'åˆ†æé¡å‹'
        required: true
        default: 'morning_scan'
        type: choice
        options:
        - morning_scan
        - afternoon_scan
        - heartbeat

jobs:
  stock-analysis:
    runs-on: ubuntu-latest
    
    steps:
    - name: æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: è¨­ç½® Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        
    - name: å®‰è£ä¾è³´å¥—ä»¶
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: æª¢æŸ¥èªæ³•
      run: |
        echo "ğŸ” æª¢æŸ¥ Python èªæ³•..."
        python -m py_compile enhanced_stock_bot.py
        python -m py_compile notifier.py
        python -m py_compile config.py
        python -m py_compile twse_data_fetcher.py
        echo "âœ… èªæ³•æª¢æŸ¥é€šéï¼"
        
    - name: æ±ºå®šåŸ·è¡Œé¡å‹
      id: run_type
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "type=${{ github.event.inputs.analysis_type }}" >> $GITHUB_OUTPUT
        else
          HOUR=$(date -u +%H)
          case $HOUR in
            0) echo "type=heartbeat" >> $GITHUB_OUTPUT ;;
            1) echo "type=morning_scan" >> $GITHUB_OUTPUT ;;
            7) echo "type=afternoon_scan" >> $GITHUB_OUTPUT ;;
            *) echo "type=heartbeat" >> $GITHUB_OUTPUT ;;
          esac
        fi
        echo "ğŸ¯ åŸ·è¡Œé¡å‹: $(cat $GITHUB_OUTPUT | grep type | cut -d= -f2)"
        
    - name: å‰µå»ºæ¸¬è©¦æª”æ¡ˆ
      run: |
        # å‰µå»ºé€šçŸ¥ç³»çµ±æ¸¬è©¦æª”æ¡ˆ
        cat > test_notification_simple.py << 'EOF'
        import os
        
        print('ğŸ”§ æª¢æŸ¥ç’°å¢ƒè®Šæ•¸:')
        print('EMAIL_SENDER:', 'âœ…' if os.getenv('EMAIL_SENDER') else 'âŒ')
        print('EMAIL_PASSWORD:', 'âœ…' if os.getenv('EMAIL_PASSWORD') else 'âŒ') 
        print('EMAIL_RECEIVER:', 'âœ…' if os.getenv('EMAIL_RECEIVER') else 'âŒ')
        
        try:
            import notifier
            notifier.init()
            if notifier.is_notification_available():
                print('âœ… é€šçŸ¥ç³»çµ±å¯ç”¨')
            else:
                print('âš ï¸ é€šçŸ¥ç³»çµ±é…ç½®ä¸å®Œæ•´')
        except Exception as e:
            print(f'âš ï¸ é€šçŸ¥ç³»çµ±æ¸¬è©¦å¤±æ•—: {e}')
        EOF
        
        # å‰µå»ºå¿ƒè·³æ¸¬è©¦æª”æ¡ˆ
        cat > heartbeat_test.py << 'EOF'
        import notifier
        import os
        from datetime import datetime
        
        print(f'ğŸ’“ é–‹å§‹å¿ƒè·³æª¢æ¸¬ - {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}')
        
        try:
            notifier.init()
            
            # ç™¼é€ç°¡å–®çš„å¿ƒè·³é€šçŸ¥
            message = f"""ğŸ”” å°è‚¡åˆ†ææ©Ÿå™¨äººå¿ƒè·³æª¢æ¸¬
            
        â° æª¢æ¸¬æ™‚é–“: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
        ğŸ¤– ç³»çµ±ç‹€æ…‹: æ­£å¸¸é‹è¡Œ
        ğŸ“§ é€šçŸ¥ç³»çµ±: é‹ä½œä¸­
        
        é€™æ˜¯è‡ªå‹•ç™¼é€çš„å¿ƒè·³æª¢æ¸¬é€šçŸ¥ï¼Œè¡¨ç¤ºç³»çµ±é‹è¡Œæ­£å¸¸ã€‚
        """
            
            result = notifier.send_notification(message, "ğŸ”” å°è‚¡åˆ†ææ©Ÿå™¨äººå¿ƒè·³æª¢æ¸¬")
            
            if result:
                print('âœ… å¿ƒè·³æª¢æ¸¬å®Œæˆï¼Œé€šçŸ¥å·²ç™¼é€')
            else:
                print('âš ï¸ å¿ƒè·³æª¢æ¸¬å®Œæˆï¼Œä½†é€šçŸ¥ç™¼é€å¤±æ•—')
                
        except Exception as e:
            print(f'âŒ å¿ƒè·³æª¢æ¸¬å¤±æ•—: {e}')
            import traceback
            traceback.print_exc()
        EOF
        
    - name: æ¸¬è©¦é€šçŸ¥ç³»çµ±
      env:
        EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        EMAIL_RECEIVER: ${{ secrets.EMAIL_RECEIVER }}
        EMAIL_SMTP_SERVER: smtp.gmail.com
        EMAIL_SMTP_PORT: 587
      run: |
        echo "ğŸ”§ æ¸¬è©¦é€šçŸ¥ç³»çµ±..."
        python test_notification_simple.py
        
    - name: åŸ·è¡Œåˆ†æ
      env:
        EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        EMAIL_RECEIVER: ${{ secrets.EMAIL_RECEIVER }}
        EMAIL_SMTP_SERVER: smtp.gmail.com
        EMAIL_SMTP_PORT: 587
        TZ: Asia/Taipei
      run: |
        TYPE="${{ steps.run_type.outputs.type }}"
        echo "ğŸš€ åŸ·è¡Œ: $TYPE"
        
        if [ "$TYPE" = "heartbeat" ]; then
          echo "åŸ·è¡Œå¿ƒè·³æª¢æ¸¬..."
          python heartbeat_test.py
        else
          echo "åŸ·è¡Œè‚¡ç¥¨åˆ†æ..."
          python enhanced_stock_bot.py $TYPE
        fi
        
    - name: å‰µå»ºæ—¥èªŒ
      if: always()
      run: |
        mkdir -p logs
        echo "$(date): åŸ·è¡Œå®Œæˆ - ${{ steps.run_type.outputs.type }}" > logs/execution.log
        echo "GitHub Run ID: ${{ github.run_id }}" >> logs/execution.log
        echo "GitHub Repository: ${{ github.repository }}" >> logs/execution.log
        
    - name: ä¸Šå‚³æ—¥èªŒ
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: logs-${{ steps.run_type.outputs.type }}-${{ github.run_number }}
        path: logs/
        retention-days: 7

  # éŒ¯èª¤é€šçŸ¥ä½œæ¥­
  error-notification:
    runs-on: ubuntu-latest
    needs: stock-analysis
    if: failure()
    
    steps:
    - name: å®‰è£ Python
      uses: actions/setup-python@v5  
      with:
        python-version: '3.9'
        
    - name: ç™¼é€éŒ¯èª¤é€šçŸ¥
      env:
        EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        EMAIL_RECEIVER: ${{ secrets.EMAIL_RECEIVER }}
      run: |
        pip install requests
        
        python3 -c "
        import os
        import smtplib
        from datetime import datetime
        from email.mime.text import MIMEText
        import ssl

        sender = os.getenv('EMAIL_SENDER')
        password = os.getenv('EMAIL_PASSWORD') 
        receiver = os.getenv('EMAIL_RECEIVER')

        if not all([sender, password, receiver]):
            print('âŒ ç¼ºå°‘éƒµä»¶é…ç½®ï¼Œè·³ééŒ¯èª¤é€šçŸ¥')
            exit(0)

        message = '''âŒ å°è‚¡åˆ†ææ©Ÿå™¨äººåŸ·è¡Œå¤±æ•—

â° å¤±æ•—æ™‚é–“: ''' + datetime.now().strftime('%Y-%m-%d %H:%M:%S') + '''
ğŸ”— æŸ¥çœ‹è©³æƒ…: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

è«‹æª¢æŸ¥ GitHub Actions æ—¥èªŒäº†è§£è©³ç´°éŒ¯èª¤è³‡è¨Šã€‚

å¯èƒ½çš„å•é¡Œï¼š
1. éƒµä»¶èªè­‰è¨­å®šå•é¡Œ  
2. è‚¡ç¥¨æ•¸æ“š API é€£æ¥å¤±æ•—
3. ç¨‹å¼åŸ·è¡Œç•°å¸¸

å»ºè­°æª¢æŸ¥ Secrets è¨­å®šå’Œç¨‹å¼æ—¥èªŒã€‚
        '''

        try:
            msg = MIMEText(message, 'plain', 'utf-8')
            msg['Subject'] = 'âŒ å°è‚¡åˆ†ææ©Ÿå™¨äººåŸ·è¡Œå¤±æ•—é€šçŸ¥'
            msg['From'] = sender
            msg['To'] = receiver

            context = ssl.create_default_context()
            server = smtplib.SMTP('smtp.gmail.com', 587)
            server.starttls(context=context)
            server.login(sender, password)
            server.send_message(msg)
            server.quit()

            print('âœ… éŒ¯èª¤é€šçŸ¥å·²ç™¼é€')
        except Exception as e:
            print(f'âŒ ç™¼é€éŒ¯èª¤é€šçŸ¥å¤±æ•—: {e}')
        "
