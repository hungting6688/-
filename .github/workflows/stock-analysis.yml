name: å°è‚¡åˆ†ææ©Ÿå™¨äºº

on:
  schedule:
    # æ—©ç›¤æƒæ - å·¥ä½œæ—¥ 09:00 (å°åŒ—æ™‚é–“)
    - cron: '0 1 * * 1-5'  # UTC 01:00 = å°åŒ—æ™‚é–“ 09:00
    # ç›¤ä¸­æƒæ - å·¥ä½œæ—¥ 10:30 (å°åŒ—æ™‚é–“)
    - cron: '30 2 * * 1-5' # UTC 02:30 = å°åŒ—æ™‚é–“ 10:30
    # åˆé–“æƒæ - å·¥ä½œæ—¥ 12:30 (å°åŒ—æ™‚é–“)
    - cron: '30 4 * * 1-5' # UTC 04:30 = å°åŒ—æ™‚é–“ 12:30
    # ç›¤å¾Œæƒæ - å·¥ä½œæ—¥ 15:00 (å°åŒ—æ™‚é–“)
    - cron: '0 7 * * 1-5'  # UTC 07:00 = å°åŒ—æ™‚é–“ 15:00
    # é€±æœ«ç¸½çµ - é€±äº” 17:00 (å°åŒ—æ™‚é–“)
    - cron: '0 9 * * 5'    # UTC 09:00 = å°åŒ—æ™‚é–“ 17:00
    # å¿ƒè·³æª¢æ¸¬ - æ¯æ—¥ 08:30 (å°åŒ—æ™‚é–“)
    - cron: '30 0 * * *'   # UTC 00:30 = å°åŒ—æ™‚é–“ 08:30
  
  # æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      analysis_type:
        description: 'åˆ†æé¡å‹'
        required: true
        default: 'morning_scan'
        type: choice
        options:
        - morning_scan
        - mid_morning_scan
        - mid_day_scan
        - afternoon_scan
        - weekly_summary
        - heartbeat

jobs:
  stock-analysis:
    runs-on: ubuntu-latest
    
    steps:
    - name: æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: å®‰è£ä¾è³´å¥—ä»¶
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: æª¢æŸ¥ Python èªæ³•
      run: |
        echo "ğŸ” æª¢æŸ¥ Python èªæ³•..."
        python -m py_compile enhanced_stock_bot.py || { echo "âŒ enhanced_stock_bot.py èªæ³•éŒ¯èª¤"; exit 1; }
        python -m py_compile notifier.py || { echo "âŒ notifier.py èªæ³•éŒ¯èª¤"; exit 1; }
        python -m py_compile twse_data_fetcher.py || { echo "âŒ twse_data_fetcher.py èªæ³•éŒ¯èª¤"; exit 1; }
        python -m py_compile config.py || { echo "âŒ config.py èªæ³•éŒ¯èª¤"; exit 1; }
        echo "âœ… æ‰€æœ‰æª”æ¡ˆèªæ³•æª¢æŸ¥é€šéï¼"
        
    - name: æ¸¬è©¦é€šçŸ¥ç³»çµ±
      env:
        EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        EMAIL_RECEIVER: ${{ secrets.EMAIL_RECEIVER }}
        EMAIL_SMTP_SERVER: ${{ secrets.EMAIL_SMTP_SERVER }}
        EMAIL_SMTP_PORT: ${{ secrets.EMAIL_SMTP_PORT }}
      run: |
        echo "ğŸ”§ æ¸¬è©¦é€šçŸ¥ç³»çµ±..."
        python -c "
        import notifier
        notifier.init()
        if notifier.is_notification_available():
            print('âœ… é€šçŸ¥ç³»çµ±å¯ç”¨')
        else:
            print('âš ï¸ é€šçŸ¥ç³»çµ±é…ç½®ä¸å®Œæ•´')
        "
        
    - name: æ±ºå®šåŸ·è¡Œé¡å‹
      id: determine_run_type
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          RUN_TYPE="${{ github.event.inputs.analysis_type }}"
        else
          # æ ¹æ“š cron æ™‚é–“æ±ºå®šåŸ·è¡Œé¡å‹
          HOUR=$(date -u +%H)
          DOW=$(date -u +%u)  # 1=Monday, 7=Sunday
          
          case $HOUR in
            0)  RUN_TYPE="heartbeat" ;;
            1)  RUN_TYPE="morning_scan" ;;
            2)  RUN_TYPE="mid_morning_scan" ;;
            4)  RUN_TYPE="mid_day_scan" ;;
            7)  RUN_TYPE="afternoon_scan" ;;
            9)  if [ $DOW -eq 5 ]; then RUN_TYPE="weekly_summary"; else RUN_TYPE="heartbeat"; fi ;;
            *)  RUN_TYPE="heartbeat" ;;
          esac
        fi
        
        echo "RUN_TYPE=$RUN_TYPE" >> $GITHUB_OUTPUT
        echo "ğŸ¯ åŸ·è¡Œé¡å‹: $RUN_TYPE"
        
    - name: åŸ·è¡Œè‚¡ç¥¨åˆ†æ
      env:
        EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        EMAIL_RECEIVER: ${{ secrets.EMAIL_RECEIVER }}
        EMAIL_SMTP_SERVER: ${{ secrets.EMAIL_SMTP_SERVER }}
        EMAIL_SMTP_PORT: ${{ secrets.EMAIL_SMTP_PORT }}
        TZ: 'Asia/Taipei'
      run: |
        RUN_TYPE="${{ steps.determine_run_type.outputs.RUN_TYPE }}"
        echo "ğŸš€ é–‹å§‹åŸ·è¡Œ: $RUN_TYPE"
        
        if [ "$RUN_TYPE" = "heartbeat" ]; then
          python -c "
          import notifier
          notifier.init()
          notifier.send_heartbeat()
          print('ğŸ’“ å¿ƒè·³æª¢æ¸¬å®Œæˆ')
          "
        else
          python enhanced_stock_bot.py $RUN_TYPE
        fi
        
    - name: ä¸Šå‚³æ—¥èªŒæª”æ¡ˆ
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: logs-${{ steps.determine_run_type.outputs.RUN_TYPE }}-${{ github.run_number }}
        path: |
          logs/
          !logs/**/*.pyc
        retention-days: 30
        
    - name: æ¸…ç†æš«å­˜æª”æ¡ˆ
      if: always()
      run: |
        echo "ğŸ§¹ æ¸…ç†æš«å­˜æª”æ¡ˆ..."
        find . -name "*.pyc" -delete
        find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
        echo "âœ… æ¸…ç†å®Œæˆ"

  # éŒ¯èª¤è™•ç†å’Œé€šçŸ¥
  error-notification:
    runs-on: ubuntu-latest
    needs: stock-analysis
    if: failure()
    
    steps:
    - name: æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: å®‰è£ä¾è³´å¥—ä»¶
      run: |
        python -m pip install --upgrade pip
        pip install requests python-dotenv
        
    - name: ç™¼é€éŒ¯èª¤é€šçŸ¥
      env:
        EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        EMAIL_RECEIVER: ${{ secrets.EMAIL_RECEIVER }}
      run: |
        python -c "
        import os
        import smtplib
        from datetime import datetime
        from email.mime.text import MIMEText

        def send_error_notification():
            sender = os.getenv('EMAIL_SENDER')
            password = os.getenv('EMAIL_PASSWORD') 
            receiver = os.getenv('EMAIL_RECEIVER')
            
            if not all([sender, password, receiver]):
                print('ç¼ºå°‘éƒµä»¶é…ç½®ï¼Œè·³ééŒ¯èª¤é€šçŸ¥')
                return
            
            message = f'''âŒ å°è‚¡åˆ†ææ©Ÿå™¨äººåŸ·è¡Œå¤±æ•—
            
        â° å¤±æ•—æ™‚é–“: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
        ğŸ”— æŸ¥çœ‹è©³æƒ…: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

        è«‹æª¢æŸ¥ GitHub Actions æ—¥èªŒäº†è§£è©³ç´°éŒ¯èª¤è³‡è¨Šã€‚
            '''
            
            try:
                msg = MIMEText(message, 'plain', 'utf-8')
                msg['Subject'] = 'âŒ å°è‚¡åˆ†ææ©Ÿå™¨äººåŸ·è¡Œå¤±æ•—é€šçŸ¥'
                msg['From'] = sender
                msg['To'] = receiver
                
                server = smtplib.SMTP('smtp.gmail.com', 587)
                server.starttls()
                server.login(sender, password)
                server.send_message(msg)
                server.quit()
                
                print('âœ… éŒ¯èª¤é€šçŸ¥å·²ç™¼é€')
            except Exception as e:
                print(f'âŒ ç™¼é€éŒ¯èª¤é€šçŸ¥å¤±æ•—: {e}')

        send_error_notification()
        "
