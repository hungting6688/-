name: ğŸš€ Taiwan Stock Analysis Bot - Enhanced Long-term Fundamental Analysis

on:
  schedule:
    # æ—©ç›¤æƒæ - å°ç£æ™‚é–“ 09:00 (UTC+8) = UTC 01:00
    - cron: '0 1 * * 1-5'
    # ç›¤ä¸­æƒæ - å°ç£æ™‚é–“ 10:30 (UTC+8) = UTC 02:30  
    - cron: '30 2 * * 1-5'
    # åˆé–“æƒæ - å°ç£æ™‚é–“ 12:30 (UTC+8) = UTC 04:30
    - cron: '30 4 * * 1-5'
    # ç›¤å¾Œæƒæ - å°ç£æ™‚é–“ 15:00 (UTC+8) = UTC 07:00 (é‡é»é•·ç·šåˆ†æ)
    - cron: '0 7 * * 1-5'
    # é€±æœ«ç¸½çµ - å°ç£æ™‚é–“é€±äº” 17:00 (UTC+8) = UTC 09:00 (æ·±åº¦é•·ç·šåˆ†æ)
    - cron: '0 9 * * 5'
    # å¿ƒè·³æª¢æ¸¬ - å°ç£æ™‚é–“ 08:30 (UTC+8) = UTC 00:30
    - cron: '30 0 * * *'
  
  # æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      analysis_type:
        description: 'é¸æ“‡åˆ†æé¡å‹'
        required: true
        default: 'afternoon_scan'
        type: choice
        options:
        - morning_scan
        - mid_morning_scan
        - mid_day_scan
        - afternoon_scan
        - weekly_summary
        - test_notification
      force_optimized:
        description: 'å¼·åˆ¶ä½¿ç”¨å„ªåŒ–ç‰ˆç³»çµ±'
        required: false
        type: boolean
        default: true

env:
  # æ™‚å€è¨­å®š
  TZ: Asia/Taipei
  
  # éƒµä»¶é…ç½® (å¾ GitHub Secrets ç²å–)
  EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
  EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
  EMAIL_RECEIVER: ${{ secrets.EMAIL_RECEIVER }}
  EMAIL_SMTP_SERVER: ${{ secrets.EMAIL_SMTP_SERVER || 'smtp.gmail.com' }}
  EMAIL_SMTP_PORT: ${{ secrets.EMAIL_SMTP_PORT || '587' }}
  EMAIL_USE_TLS: 'True'
  
  # å„ªåŒ–ç‰ˆç³»çµ±é…ç½®
  ENHANCED_ANALYSIS: 'True'
  LONG_TERM_FOCUS: 'True'
  
  # å¸‚å ´ç’°å¢ƒé…ç½® (å¯æ ¹æ“šå¸‚æ³èª¿æ•´)
  MARKET_ENVIRONMENT: ${{ secrets.MARKET_ENVIRONMENT || 'neutral' }}
  
  # åˆ†æé…ç½®
  USE_FUNDAMENTAL_ANALYSIS: 'True'
  USE_INSTITUTIONAL_ANALYSIS: 'True'
  
  # é€šçŸ¥é…ç½®
  NOTIFICATION_ENABLED: 'True'
  HTML_EMAIL: 'True'

jobs:
  stock-analysis:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python Environment
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        echo "ğŸ“¦ å®‰è£å¥—ä»¶ä¾è³´..."
        pip install --upgrade pip
        pip install -r requirements.txt
        echo "âœ… å¥—ä»¶å®‰è£å®Œæˆ"
        
    - name: ğŸ”§ Setup Environment
      run: |
        echo "ğŸ”§ è¨­ç½®åŸ·è¡Œç’°å¢ƒ..."
        
        # å‰µå»ºå¿…è¦ç›®éŒ„
        mkdir -p logs cache data data/analysis_results data/analysis_results_optimized
        
        # é¡¯ç¤ºæ™‚å€è³‡è¨Š
        echo "ğŸŒ ç•¶å‰æ™‚å€: $(date)"
        echo "ğŸŒ å°ç£æ™‚é–“: $(TZ=Asia/Taipei date)"
        
        # æª¢æŸ¥å„ªåŒ–ç‰ˆç³»çµ±æ–‡ä»¶
        if [ -f "enhanced_stock_bot_optimized.py" ] && [ -f "optimized_notifier.py" ]; then
          echo "âœ… å„ªåŒ–ç‰ˆç³»çµ±æª”æ¡ˆå°±ç·’"
          echo "OPTIMIZED_SYSTEM_AVAILABLE=true" >> $GITHUB_ENV
        else
          echo "âš ï¸ å„ªåŒ–ç‰ˆç³»çµ±æª”æ¡ˆä¸å­˜åœ¨ï¼Œå°‡ä½¿ç”¨æ¨™æº–ç‰ˆ"
          echo "OPTIMIZED_SYSTEM_AVAILABLE=false" >> $GITHUB_ENV
        fi
        
        # æª¢æŸ¥å¿…è¦é…ç½®
        if [ -z "$EMAIL_SENDER" ] || [ -z "$EMAIL_PASSWORD" ] || [ -z "$EMAIL_RECEIVER" ]; then
          echo "âŒ éƒµä»¶é…ç½®ä¸å®Œæ•´"
          echo "EMAIL_CONFIG_VALID=false" >> $GITHUB_ENV
        else
          echo "âœ… éƒµä»¶é…ç½®æª¢æŸ¥é€šé"
          echo "EMAIL_CONFIG_VALID=true" >> $GITHUB_ENV
        fi
        
    - name: ğŸ•’ Determine Analysis Type
      run: |
        echo "ğŸ•’ æ±ºå®šåˆ†æé¡å‹..."
        
        # å¦‚æœæ˜¯æ‰‹å‹•è§¸ç™¼
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          ANALYSIS_TYPE="${{ github.event.inputs.analysis_type }}"
          echo "ğŸ‘¤ æ‰‹å‹•è§¸ç™¼: $ANALYSIS_TYPE"
        else
          # æ ¹æ“šæ’ç¨‹æ™‚é–“æ±ºå®šåˆ†æé¡å‹
          CURRENT_HOUR=$(TZ=Asia/Taipei date +%H)
          CURRENT_DAY=$(TZ=Asia/Taipei date +%u)  # 1=Monday, 7=Sunday
          
          echo "ğŸ“… ç•¶å‰æ™‚é–“: $(TZ=Asia/Taipei date)"
          echo "â° å°æ™‚: $CURRENT_HOUR, æ˜ŸæœŸ: $CURRENT_DAY"
          
          case $CURRENT_HOUR in
            01) ANALYSIS_TYPE="morning_scan" ;;      # 09:00 å°ç£æ™‚é–“
            02) ANALYSIS_TYPE="mid_morning_scan" ;;  # 10:30 å°ç£æ™‚é–“  
            04) ANALYSIS_TYPE="mid_day_scan" ;;      # 12:30 å°ç£æ™‚é–“
            07) ANALYSIS_TYPE="afternoon_scan" ;;    # 15:00 å°ç£æ™‚é–“
            09) if [ $CURRENT_DAY -eq 5 ]; then     # é€±äº”
                  ANALYSIS_TYPE="weekly_summary"     # 17:00 å°ç£æ™‚é–“
                else
                  ANALYSIS_TYPE="afternoon_scan"
                fi ;;
            00) ANALYSIS_TYPE="heartbeat" ;;         # 08:30 å°ç£æ™‚é–“
            *) ANALYSIS_TYPE="afternoon_scan" ;;     # é è¨­å€¼
          esac
          
          echo "ğŸ¤– è‡ªå‹•æ’ç¨‹: $ANALYSIS_TYPE"
        fi
        
        echo "ANALYSIS_TYPE=$ANALYSIS_TYPE" >> $GITHUB_ENV
        echo "ğŸ“Š å°‡åŸ·è¡Œ: $ANALYSIS_TYPE"
        
    - name: ğŸ’ Run Optimized Stock Analysis
      if: env.OPTIMIZED_SYSTEM_AVAILABLE == 'true' && env.EMAIL_CONFIG_VALID == 'true'
      run: |
        echo "ğŸ’ åŸ·è¡Œå„ªåŒ–ç‰ˆè‚¡å¸‚åˆ†æ..."
        echo "ğŸ“Š åˆ†æé¡å‹: $ANALYSIS_TYPE"
        
        # é¡¯ç¤ºå„ªåŒ–ç‰ˆç‰¹è‰²
        echo "âœ¨ å„ªåŒ–ç‰ˆç‰¹è‰²:"
        echo "  ğŸ“ˆ é•·ç·šæ¨è–¦åŸºæœ¬é¢æ¬Šé‡æå‡ 140%"
        echo "  ğŸ¦ æ³•äººè²·è³£æ¬Šé‡æå‡ 33%"  
        echo "  ğŸ’¸ æ®–åˆ©ç‡ > 2.5% å„ªå…ˆæ¨è–¦"
        echo "  ğŸ“Š EPSæˆé•· > 8% å„ªå…ˆæ¨è–¦"
        echo "  ğŸ’° æ³•äººè²·è¶… > 5000è¬ å„ªå…ˆæ¨è–¦"
        
        # æ ¹æ“šåˆ†æé¡å‹é¡¯ç¤ºé æœŸçµæœ
        case $ANALYSIS_TYPE in
          "morning_scan")
            echo "ğŸŒ… æ—©ç›¤æƒæ: 200æ”¯è‚¡ç¥¨ï¼ŒçŸ­ç·šæ¨è–¦å„ªå…ˆ"
            ;;
          "mid_morning_scan")
            echo "â˜€ï¸ ç›¤ä¸­æƒæ: 300æ”¯è‚¡ç¥¨ï¼ŒçŸ­ç·šæ¨è–¦å„ªå…ˆ"
            ;;
          "mid_day_scan")
            echo "ğŸŒ åˆé–“æƒæ: 300æ”¯è‚¡ç¥¨ï¼Œæ··åˆåˆ†æ"
            ;;
          "afternoon_scan")
            echo "ğŸŒ‡ ç›¤å¾Œæƒæ: 1000æ”¯è‚¡ç¥¨ï¼Œé•·ç·šæ¨è–¦å¢åŠ è‡³4æ”¯"
            echo "ğŸ’ é‡é»é—œæ³¨åŸºæœ¬é¢å„ªè³ªè‚¡"
            ;;
          "weekly_summary")
            echo "ğŸ“ˆ é€±æœ«ç¸½çµ: 1000æ”¯è‚¡ç¥¨ï¼Œé•·ç·šæ¨è–¦å¢åŠ è‡³5æ”¯"
            echo "ğŸ’ æ·±åº¦æŒ–æ˜åŸºæœ¬é¢å„ªè³ªè‚¡ï¼Œæœ€ä½³é•·ç·šåˆ†ææ™‚æ®µ"
            ;;
          "heartbeat")
            echo "ğŸ’“ ç³»çµ±å¿ƒè·³æª¢æ¸¬"
            ;;
          "test_notification")
            echo "ğŸ“§ æ¸¬è©¦é€šçŸ¥åŠŸèƒ½"
            ;;
        esac
        
        # åŸ·è¡Œåˆ†æ
        if [ "$ANALYSIS_TYPE" = "heartbeat" ]; then
          python -c "
import sys
sys.path.append('.')
try:
    import optimized_notifier as notifier
    notifier.init()
    result = notifier.send_heartbeat()
    print('ğŸ’“ å¿ƒè·³æª¢æ¸¬å®Œæˆ:', 'æˆåŠŸ' if result else 'å¤±æ•—')
except Exception as e:
    print('âŒ å¿ƒè·³æª¢æ¸¬å¤±æ•—:', str(e))
    # å˜—è©¦ä½¿ç”¨æ¨™æº–ç‰ˆ
    try:
        import notifier
        notifier.init()
        result = notifier.send_heartbeat()
        print('ğŸ’“ æ¨™æº–ç‰ˆå¿ƒè·³æª¢æ¸¬å®Œæˆ:', 'æˆåŠŸ' if result else 'å¤±æ•—')
    except Exception as e2:
        print('âŒ æ¨™æº–ç‰ˆå¿ƒè·³ä¹Ÿå¤±æ•—:', str(e2))
        sys.exit(1)
"
        elif [ "$ANALYSIS_TYPE" = "test_notification" ]; then
          python run_optimized_system.py test
        else
          python run_optimized_system.py run --slot $ANALYSIS_TYPE
        fi
        
    - name: ğŸ“Š Run Standard Stock Analysis
      if: env.OPTIMIZED_SYSTEM_AVAILABLE == 'false' && env.EMAIL_CONFIG_VALID == 'true'
      run: |
        echo "ğŸ“Š åŸ·è¡Œæ¨™æº–ç‰ˆè‚¡å¸‚åˆ†æ..."
        echo "âš ï¸ å„ªåŒ–ç‰ˆç³»çµ±ä¸å¯ç”¨ï¼Œä½¿ç”¨æ¨™æº–ç‰ˆ"
        echo "ğŸ“Š åˆ†æé¡å‹: $ANALYSIS_TYPE"
        
        # åŸ·è¡Œæ¨™æº–ç‰ˆåˆ†æ
        if [ "$ANALYSIS_TYPE" = "heartbeat" ]; then
          python -c "
import sys
sys.path.append('.')
try:
    import notifier
    notifier.init()
    result = notifier.send_heartbeat()
    print('ğŸ’“ å¿ƒè·³æª¢æ¸¬å®Œæˆ:', 'æˆåŠŸ' if result else 'å¤±æ•—')
except Exception as e:
    print('âŒ å¿ƒè·³æª¢æ¸¬å¤±æ•—:', str(e))
    sys.exit(1)
"
        elif [ "$ANALYSIS_TYPE" = "test_notification" ]; then
          python test_notification.py --test all
        else
          # ä½¿ç”¨æ¨™æº–ç‰ˆåˆ†æ
          if [ -f "enhanced_stock_bot.py" ]; then
            python enhanced_stock_bot.py $ANALYSIS_TYPE
          elif [ -f "stock_bot.py" ]; then  
            python stock_bot.py $ANALYSIS_TYPE
          else
            echo "âŒ æ‰¾ä¸åˆ°å¯åŸ·è¡Œçš„åˆ†æç¨‹å¼"
            exit 1
          fi
        fi
        
    - name: âŒ Handle Missing Configuration
      if: env.EMAIL_CONFIG_VALID == 'false'
      run: |
        echo "âŒ éƒµä»¶é…ç½®ä¸å®Œæ•´ï¼Œç„¡æ³•åŸ·è¡Œåˆ†æ"
        echo ""
        echo "ğŸ”§ è«‹åœ¨ GitHub Repository Settings > Secrets ä¸­è¨­å®šï¼š"
        echo "  ğŸ“§ EMAIL_SENDER - ç™¼ä»¶äººéƒµç®±"
        echo "  ğŸ”‘ EMAIL_PASSWORD - éƒµç®±æ‡‰ç”¨ç¨‹å¼å¯†ç¢¼"
        echo "  ğŸ“¨ EMAIL_RECEIVER - æ”¶ä»¶äººéƒµç®±"
        echo ""
        echo "ğŸ’¡ Gmail ç”¨æˆ¶è«‹ä½¿ç”¨æ‡‰ç”¨ç¨‹å¼å¯†ç¢¼ï¼ˆ16ä½æ•¸ï¼‰"
        echo "ğŸ’¡ è¨­å®šæ­¥é©Ÿï¼š"
        echo "  1. å•Ÿç”¨ Google å…©æ­¥é©Ÿé©—è­‰"
        echo "  2. ç”Ÿæˆæ‡‰ç”¨ç¨‹å¼å¯†ç¢¼"
        echo "  3. å°‡16ä½å¯†ç¢¼è¨­ç‚º EMAIL_PASSWORD"
        echo ""
        
        # å‰µå»ºæé†’æª”æ¡ˆ
        echo "éƒµä»¶é…ç½®ç¼ºå¤± - $(date)" > missing_config.log
        
        exit 1
        
    - name: ğŸ“‹ Analysis Summary
      if: success()
      run: |
        echo "ğŸ“‹ åˆ†æåŸ·è¡Œæ‘˜è¦"
        echo "==============================================="
        echo "â° åŸ·è¡Œæ™‚é–“: $(TZ=Asia/Taipei date)"
        echo "ğŸ“Š åˆ†æé¡å‹: $ANALYSIS_TYPE"
        echo "ğŸ’ ç³»çµ±ç‰ˆæœ¬: $([ "$OPTIMIZED_SYSTEM_AVAILABLE" = "true" ] && echo "å„ªåŒ–ç‰ˆï¼ˆé•·ç·šåŸºæœ¬é¢å¼·åŒ–ï¼‰" || echo "æ¨™æº–ç‰ˆ")"
        echo "ğŸ“§ é€šçŸ¥ç‹€æ…‹: $([ "$EMAIL_CONFIG_VALID" = "true" ] && echo "å·²ç™¼é€" || echo "é…ç½®éŒ¯èª¤")"
        echo ""
        
        if [ "$OPTIMIZED_SYSTEM_AVAILABLE" = "true" ]; then
          echo "âœ¨ å„ªåŒ–ç‰ˆåŠŸèƒ½å·²å•Ÿç”¨ï¼š"
          echo "  ğŸ’ é•·ç·šæ¨è–¦åŸºæœ¬é¢åˆ†æå¼·åŒ–"
          echo "  ğŸ“Š é‡é»é—œæ³¨ï¼šæ®–åˆ©ç‡ã€EPSæˆé•·ã€æ³•äººè²·è¶…"
          echo "  ğŸ¯ æ¨è–¦æ¨™æº–ï¼šæ›´åš´æ ¼çš„åŸºæœ¬é¢ç¯©é¸"
          echo "  ğŸ“§ é€šçŸ¥å„ªåŒ–ï¼šè©³ç´°åŸºæœ¬é¢è³‡è¨Šé¡¯ç¤º"
        fi
        
        # æ ¹æ“šåˆ†æé¡å‹é¡¯ç¤ºç‰¹è‰²
        case $ANALYSIS_TYPE in
          "afternoon_scan"|"weekly_summary")
            echo ""
            echo "ğŸ’ é•·ç·šåˆ†æé‡é»ï¼š"
            echo "  ğŸ“ˆ 1000æ”¯è‚¡ç¥¨æ·±åº¦åˆ†æ"
            echo "  ğŸ’¸ å„ªå…ˆæ¨è–¦é«˜æ®–åˆ©ç‡è‚¡ç¥¨ï¼ˆ>2.5%ï¼‰"
            echo "  ğŸ“Š å„ªå…ˆæ¨è–¦EPSé«˜æˆé•·è‚¡ç¥¨ï¼ˆ>8%ï¼‰"
            echo "  ğŸ¦ å„ªå…ˆæ¨è–¦æ³•äººå¤§é¡è²·è¶…è‚¡ç¥¨ï¼ˆ>5000è¬ï¼‰"
            echo "  ğŸ† é‡è¦–ROEã€é€£çºŒé…æ¯ç­‰å“è³ªæŒ‡æ¨™"
            ;;
        esac
        
        echo "==============================================="
        echo "âœ… è‚¡å¸‚åˆ†æç³»çµ±åŸ·è¡Œå®Œæˆ"
        
    - name: ğŸ—‚ï¸ Archive Analysis Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: stock-analysis-results-${{ env.ANALYSIS_TYPE }}-${{ github.run_number }}
        path: |
          logs/
          data/analysis_results*/
          *.log
        retention-days: 30
        
    - name: ğŸ’¬ Workflow Status Notification
      if: failure()
      run: |
        echo "âŒ å·¥ä½œæµç¨‹åŸ·è¡Œå¤±æ•—"
        echo "ğŸ“Š åˆ†æé¡å‹: $ANALYSIS_TYPE"
        echo "â° å¤±æ•—æ™‚é–“: $(TZ=Asia/Taipei date)"
        echo ""
        echo "ğŸ” å¯èƒ½åŸå› ï¼š"
        echo "  1. éƒµä»¶é…ç½®éŒ¯èª¤"
        echo "  2. ç¶²è·¯é€£ç·šå•é¡Œ"
        echo "  3. å°è‚¡è³‡æ–™æºç•°å¸¸"
        echo "  4. ç¨‹å¼ç¢¼éŒ¯èª¤"
        echo ""
        echo "ğŸ’¡ å»ºè­°æª¢æŸ¥ï¼š"
        echo "  - GitHub Secrets éƒµä»¶è¨­å®š"
        echo "  - ç¨‹å¼ç¢¼æ˜¯å¦æ­£ç¢º"
        echo "  - åŸ·è¡Œæ—¥èªŒéŒ¯èª¤è¨Šæ¯"
