name: Enhanced Taiwan Stock Bot

on:
  schedule:
    # å°ç£æ™‚é–“ = UTC + 8
    - cron: '0 1 * * 1-5'    # 09:00 æ—©ç›¤æŽƒæ
    - cron: '30 2 * * 1-5'   # 10:30 ç›¤ä¸­æŽƒæ
    - cron: '30 4 * * 1-5'   # 12:30 åˆé–“æŽƒæ
    - cron: '0 7 * * 1-5'    # 15:00 ç›¤å¾ŒæŽƒæ
    - cron: '0 9 * * 5'      # 17:00 é€±æœ«ç¸½çµï¼ˆåƒ…é€±äº”ï¼‰
 
  - name: æª¢æŸ¥èªžæ³•
  run: |
    python -m py_compile enhanced_stock_bot.py
    python -m py_compile notifier.py
    python -m py_compile twse_data_fetcher.py
    
  workflow_dispatch:
    inputs:
      run_type:
        description: 'é‹è¡Œé¡žåž‹'
        required: true
        default: 'morning_scan'
        type: choice
        options:
          - morning_scan
          - mid_morning_scan
          - mid_day_scan
          - afternoon_scan
          - weekly_summary

jobs:
  stock-analysis:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # 15åˆ†é˜ç¸½è¶…æ™‚
    
    steps:
    - name: æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: å»ºç«‹å¿…è¦ç›®éŒ„
      run: |
        mkdir -p logs cache data
        mkdir -p data/analysis_results
        mkdir -p logs/notifications
        
    - name: è¨­ç½® Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        
    - name: å®‰è£æ ¸å¿ƒä¾è³´
      run: |
        pip install --upgrade pip
        pip install requests pandas numpy python-dotenv pytz schedule beautifulsoup4 lxml
        
    - name: åŸ·è¡Œè‚¡ç¥¨åˆ†æž
      timeout-minutes: 12
      env:
        EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        EMAIL_RECEIVER: ${{ secrets.EMAIL_RECEIVER }}
        EMAIL_SMTP_SERVER: ${{ secrets.EMAIL_SMTP_SERVER || 'smtp.gmail.com' }}
        EMAIL_SMTP_PORT: ${{ secrets.EMAIL_SMTP_PORT || '587' }}
        EMAIL_USE_TLS: ${{ secrets.EMAIL_USE_TLS || 'True' }}
      run: |
        RUN_TYPE="${{ github.event.inputs.run_type || 'morning_scan' }}"
        
        case "$RUN_TYPE" in
          "morning_scan")
            echo "ðŸŒ… åŸ·è¡Œæ—©ç›¤æŽƒæ (æŽƒæ200æ”¯è‚¡ç¥¨ï¼Œä½¿ç”¨å¿«é€Ÿåˆ†æž)..."
            ;;
          "mid_morning_scan")
            echo "ðŸ“ˆ åŸ·è¡Œç›¤ä¸­æŽƒæ (æŽƒæ300æ”¯è‚¡ç¥¨ï¼Œä½¿ç”¨å¿«é€Ÿåˆ†æž)..."
            ;;
          "mid_day_scan")
            echo "ðŸ• åŸ·è¡Œåˆé–“æŽƒæ (æŽƒæ300æ”¯è‚¡ç¥¨ï¼Œä½¿ç”¨å¿«é€Ÿåˆ†æž)..."
            ;;
          "afternoon_scan")
            echo "ðŸŒ† åŸ·è¡Œç›¤å¾ŒæŽƒæ (æŽƒæ1000æ”¯è‚¡ç¥¨ï¼Œä½¿ç”¨å¿«é€Ÿåˆ†æž)..."
            ;;
          "weekly_summary")
            echo "ðŸ“Š åŸ·è¡Œé€±æœ«ç¸½çµ (æŽƒæ500æ”¯è‚¡ç¥¨ï¼Œä½¿ç”¨å¿«é€Ÿåˆ†æž)..."
            ;;
        esac
        
        # åŸ·è¡Œæ”¹é€²ç‰ˆåˆ†æž
        python -c "
        import sys
        import traceback
        from datetime import datetime
        
        print(f'â° é–‹å§‹æ™‚é–“: {datetime.now().strftime(\"%H:%M:%S\")}')
        
        try:
            from enhanced_stock_bot import EnhancedStockBot
            print('âœ… æˆåŠŸå°Žå…¥æ”¹é€²ç‰ˆåˆ†æžæ¨¡çµ„')
            
            bot = EnhancedStockBot()
            print('âœ… åˆ†æžæ©Ÿå™¨äººåˆå§‹åŒ–å®Œæˆ')
            
            bot.run_analysis('$RUN_TYPE')
            
            end_time = datetime.now().strftime('%H:%M:%S')
            print(f'ðŸŽ‰ åˆ†æžå®Œæˆ! çµæŸæ™‚é–“: {end_time}')
            print('ðŸ“§ è«‹æª¢æŸ¥æ‚¨çš„éƒµç®±!')
            
        except Exception as e:
            print(f'âŒ åˆ†æžåŸ·è¡Œå¤±æ•—: {e}')
            traceback.print_exc()
            
            # å˜—è©¦ç·Šæ€¥å‚™ç”¨åˆ†æž
            print('ðŸš¨ å•Ÿå‹•ç·Šæ€¥å‚™ç”¨åˆ†æž...')
            try:
                from twse_data_fetcher import TWStockDataFetcher
                import notifier
                
                fetcher = TWStockDataFetcher()
                notifier.init()
                
                # ç°¡åŒ–åˆ†æž
                stocks = fetcher.get_stocks_by_time_slot('$RUN_TYPE')
                if stocks:
                    top_stocks = sorted(stocks, key=lambda x: x.get('trade_value', 0), reverse=True)[:20]
                    
                    short_term = []
                    for stock in top_stocks:
                        if stock.get('change_percent', 0) > 2 and len(short_term) < 3:
                            short_term.append({
                                'code': stock['code'],
                                'name': stock['name'],
                                'current_price': stock['close'],
                                'reason': f'ä»Šæ—¥ä¸Šæ¼² {stock[\"change_percent\"]:.1f}%ï¼Œè¡¨ç¾å¼·å‹¢',
                                'target_price': round(stock['close'] * 1.05, 1),
                                'stop_loss': round(stock['close'] * 0.97, 1),
                                'trade_value': stock['trade_value']
                            })
                    
                    if short_term:
                        recommendations = {'short_term': short_term, 'long_term': [], 'weak_stocks': []}
                        notifier.send_combined_recommendations(recommendations, 'ç·Šæ€¥å‚™ç”¨åˆ†æž')
                        print('âœ… ç·Šæ€¥å‚™ç”¨åˆ†æžå®Œæˆ')
                    else:
                        print('âš ï¸ ç·Šæ€¥åˆ†æžç„¡æŽ¨è–¦çµæžœ')
                else:
                    print('âŒ ç·Šæ€¥åˆ†æžä¹Ÿç„¡æ³•ç²å–æ•¸æ“š')
                    
            except Exception as e2:
                print(f'âŒ ç·Šæ€¥åˆ†æžä¹Ÿå¤±æ•—: {e2}')
                sys.exit(1)
        "
        
    - name: æª¢æŸ¥åŸ·è¡Œçµæžœ
      if: always()
      run: |
        echo "ðŸ“‹ === åŸ·è¡Œçµæžœæª¢æŸ¥ ==="
        
        # æª¢æŸ¥æ—¥èªŒ
        if [ -f "logs/stock_bot.log" ]; then
          echo "ðŸ“„ æœ€æ–°æ—¥èªŒ (æœ€å¾Œ10è¡Œ):"
          tail -10 logs/stock_bot.log
        else
          echo "âš ï¸ æœªæ‰¾åˆ°æ—¥èªŒæª”æ¡ˆ"
        fi
        
        # æª¢æŸ¥åˆ†æžçµæžœ
        if [ -d "data/analysis_results" ]; then
          echo "ðŸ“Š åˆ†æžçµæžœ:"
          find data/analysis_results -name "*.json" -type f | head -5
        else
          echo "âš ï¸ æœªæ‰¾åˆ°åˆ†æžçµæžœ"
        fi
        
        echo "âœ… æª¢æŸ¥å®Œæˆ"
        
    - name: ä¸Šå‚³åŸ·è¡Œçµæžœ
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: stock-analysis-${{ github.event.inputs.run_type || 'auto' }}-${{ github.run_number }}
        path: |
          logs/
          data/
          cache/
        if-no-files-found: ignore
        retention-days: 3
