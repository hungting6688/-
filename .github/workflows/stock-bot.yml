name: Enhanced Taiwan Stock Bot

on:
  schedule:
    # åŸ·è¡Œæ™‚é–“ä»¥ UTC ç‚ºæº–ï¼Œå°ç£æ™‚é–“éœ€è¦åŠ  8 å°æ™‚
    - cron: '0 1 * * 1-5'    # æ—©ç›¤æƒæ (é€±ä¸€è‡³é€±äº”) - å°ç£æ™‚é–“09:00
    - cron: '30 2 * * 1-5'   # ç›¤ä¸­æƒæ (é€±ä¸€è‡³é€±äº”) - å°ç£æ™‚é–“10:30
    - cron: '30 4 * * 1-5'   # åˆé–“æƒæ (é€±ä¸€è‡³é€±äº”) - å°ç£æ™‚é–“12:30
    - cron: '0 7 * * 1-5'    # ç›¤å¾Œæƒæ (é€±ä¸€è‡³é€±äº”) - å°ç£æ™‚é–“15:00
    - cron: '0 9 * * 5'      # é€±æœ«ç¸½çµ (åƒ…é€±äº”) - å°ç£æ™‚é–“17:00
  
  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      run_type:
        description: 'é‹è¡Œé¡å‹'
        required: true
        default: 'morning_scan'
        type: choice
        options:
          - morning_scan
          - mid_morning_scan
          - mid_day_scan
          - afternoon_scan
          - weekly_summary
          - test_data
          - test_analysis

jobs:
  run-enhanced-stock-bot:
    runs-on: ubuntu-latest
    
    steps:
    - name: æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: å»ºç«‹å¿…è¦ç›®éŒ„
      run: |
        mkdir -p logs cache data
        mkdir -p data/analysis_results
        mkdir -p logs/notifications
        mkdir -p logs/undelivered
      
    - name: è¨­ç½® Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        cache: 'pip'
        
    - name: ä¿®æ­£æª”æ¡ˆåç¨±ä¸¦å®‰è£ä¾è³´
      run: |
        # æª¢æŸ¥ä¸¦ä¿®æ­£requirementsæª”å
        if [ -f "requirement.txt" ] && [ ! -f "requirements.txt" ]; then
          echo "é‡æ–°å‘½å requirement.txt -> requirements.txt"
          mv requirement.txt requirements.txt
        fi
        
        # å‡ç´špip
        python -m pip install --upgrade pip
        
        # å…ˆå®‰è£æ ¸å¿ƒä¾è³´
        pip install requests pandas numpy schedule python-dotenv pytz
        
        # å†å®‰è£å…¶ä»–ä¾è³´ï¼Œå¿½ç•¥å¤±æ•—çš„å¥—ä»¶
        if [ -f "requirements.txt" ]; then
          echo "å®‰è£requirements.txtä¸­çš„å¥—ä»¶ï¼ˆå¿½ç•¥éŒ¯èª¤ï¼‰"
          pip install -r requirements.txt || echo "éƒ¨åˆ†å¥—ä»¶å®‰è£å¤±æ•—ï¼Œä½†ç¹¼çºŒåŸ·è¡Œ"
        fi
        
        # é¡¯ç¤ºå·²å®‰è£çš„å¥—ä»¶
        echo "å·²å®‰è£çš„å¥—ä»¶ï¼š"
        pip list | grep -E "(requests|pandas|numpy|schedule|dotenv|pytz)"
        
    - name: æª¢æŸ¥ç’°å¢ƒè®Šæ•¸é…ç½®
      run: |
        echo "æª¢æŸ¥å¿…è¦çš„ç’°å¢ƒè®Šæ•¸é…ç½®..."
        python -c "
        import os
        required_vars = ['EMAIL_SENDER', 'EMAIL_PASSWORD', 'EMAIL_RECEIVER']
        missing_vars = [var for var in required_vars if not os.getenv(var)]
        
        if missing_vars:
            print(f'âŒ ç¼ºå°‘ç’°å¢ƒè®Šæ•¸: {missing_vars}')
            print('è«‹åœ¨GitHub Secretsä¸­è¨­å®šé€™äº›è®Šæ•¸')
            exit(1)
        else:
            print('âœ… å¿…è¦ç’°å¢ƒè®Šæ•¸å·²è¨­å®š')
            print(f'EMAIL_SENDER: {os.getenv(\"EMAIL_SENDER\")}')
            print(f'EMAIL_RECEIVER: {os.getenv(\"EMAIL_RECEIVER\")}')
        "
      env:
        EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        EMAIL_RECEIVER: ${{ secrets.EMAIL_RECEIVER }}
        EMAIL_SMTP_SERVER: ${{ secrets.EMAIL_SMTP_SERVER || 'smtp.gmail.com' }}
        EMAIL_SMTP_PORT: ${{ secrets.EMAIL_SMTP_PORT || '587' }}
        
    - name: æª¢æŸ¥å°è‚¡æ•¸æ“šé€£ç·š
      run: |
        echo "æª¢æŸ¥å°ç£è­‰åˆ¸äº¤æ˜“æ‰€APIé€£ç·šç‹€æ…‹..."
        python -c "
        import requests
        import time
        
        # æ¸¬è©¦TWSE API
        try:
            response = requests.get('https://www.twse.com.tw/exchangeReport/STOCK_DAY_ALL?response=json', timeout=15)
            if response.status_code == 200:
                data = response.json()
                if data.get('stat') == 'OK':
                    print('âœ… å°ç£è­‰åˆ¸äº¤æ˜“æ‰€APIé€£ç·šæ­£å¸¸')
                    print(f'   å–å¾— {len(data.get(\"data\", []))} ç­†è‚¡ç¥¨è³‡æ–™')
                else:
                    print(f'âš ï¸ TWSE APIå›æ‡‰ç•°å¸¸: {data.get(\"stat\")}')
            else:
                print(f'âš ï¸ TWSE API HTTPç‹€æ…‹ç¢¼: {response.status_code}')
        except Exception as e:
            print(f'âŒ ç„¡æ³•é€£æ¥TWSE API: {e}')
        
        time.sleep(2)
        
        # æ¸¬è©¦TPEX API
        try:
            from datetime import datetime
            today = datetime.now()
            minguo_date = f'{today.year-1911}/{today.month:02d}/{today.day:02d}'
            
            response = requests.get(f'https://www.tpex.org.tw/web/stock/aftertrading/otc_quotes_no1430/stk_wn1430_result.php?l=zh-tw&d={minguo_date}&se=EW&o=json', timeout=15)
            if response.status_code == 200:
                print('âœ… å°ç£è­‰åˆ¸æ«ƒæª¯è²·è³£ä¸­å¿ƒAPIé€£ç·šæ­£å¸¸')
            else:
                print(f'âš ï¸ TPEX API HTTPç‹€æ…‹ç¢¼: {response.status_code}')
        except Exception as e:
            print(f'âŒ ç„¡æ³•é€£æ¥TPEX API: {e}')
        "
        
    - name: åŸ·è¡Œå¯¦éš›æ•¸æ“šæ¸¬è©¦
      if: github.event.inputs.run_type == 'test_data' || github.event.inputs.run_type == 'test_analysis'
      env:
        EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        EMAIL_RECEIVER: ${{ secrets.EMAIL_RECEIVER }}
        EMAIL_SMTP_SERVER: ${{ secrets.EMAIL_SMTP_SERVER || 'smtp.gmail.com' }}
        EMAIL_SMTP_PORT: ${{ secrets.EMAIL_SMTP_PORT || '587' }}
      run: |
        echo "åŸ·è¡Œå¯¦éš›æ•¸æ“šæ¸¬è©¦..."
        
        if [ "${{ github.event.inputs.run_type }}" = "test_data" ]; then
          python test_real_data.py --test data
        elif [ "${{ github.event.inputs.run_type }}" = "test_analysis" ]; then
          python test_real_data.py --test analysis
        fi
        
    - name: åŸ·è¡Œå¢å¼·ç‰ˆè‚¡ç¥¨åˆ†æ
      if: github.event.inputs.run_type != 'test_data' && github.event.inputs.run_type != 'test_analysis'
      env:
        EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        EMAIL_RECEIVER: ${{ secrets.EMAIL_RECEIVER }}
        EMAIL_SMTP_SERVER: ${{ secrets.EMAIL_SMTP_SERVER || 'smtp.gmail.com' }}
        EMAIL_SMTP_PORT: ${{ secrets.EMAIL_SMTP_PORT || '587' }}
        EMAIL_USE_TLS: ${{ secrets.EMAIL_USE_TLS || 'True' }}
        LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
        LINE_USER_ID: ${{ secrets.LINE_USER_ID }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        echo "ç›®å‰å·¥ä½œç›®éŒ„: $(pwd)"
        echo "Pythonç‰ˆæœ¬: $(python --version)"
        
        # æ±ºå®šåŸ·è¡Œçš„åˆ†æé¡å‹
        RUN_TYPE="${{ github.event.inputs.run_type || 'morning_scan' }}"
        echo "åŸ·è¡Œåˆ†æé¡å‹: $RUN_TYPE"
        
        # é¡¯ç¤ºè¦åŸ·è¡Œçš„åˆ†æèªªæ˜
        case "$RUN_TYPE" in
          "morning_scan")
            echo "ğŸŒ… åŸ·è¡Œæ—©ç›¤æƒæ (100æ”¯è‚¡ç¥¨)..."
            ;;
          "mid_morning_scan")
            echo "ğŸ“ˆ åŸ·è¡Œç›¤ä¸­æƒæ (150æ”¯è‚¡ç¥¨)..."
            ;;
          "mid_day_scan")
            echo "ğŸ• åŸ·è¡Œåˆé–“æƒæ (150æ”¯è‚¡ç¥¨)..."
            ;;
          "afternoon_scan")
            echo "ğŸŒ† åŸ·è¡Œç›¤å¾Œæƒæ (450æ”¯è‚¡ç¥¨)..."
            ;;
          "weekly_summary")
            echo "ğŸ“Š åŸ·è¡Œé€±æœ«ç¸½çµ (200æ”¯è‚¡ç¥¨)..."
            ;;
        esac
        
        # åŸ·è¡Œè‚¡ç¥¨åˆ†æï¼Œå¢åŠ éŒ¯èª¤è™•ç†
        python -c "
        import sys
        import traceback
        
        try:
            from enhanced_stock_bot import EnhancedStockBot
            print('âœ… æˆåŠŸåŒ¯å…¥åˆ†ææ¨¡çµ„')
            
            bot = EnhancedStockBot()
            print('âœ… æˆåŠŸåˆå§‹åŒ–åˆ†ææ©Ÿå™¨äºº')
            
            bot.run_analysis('$RUN_TYPE')
            print('âœ… åˆ†æåŸ·è¡Œå®Œæˆ')
            
        except ImportError as e:
            print(f'âŒ æ¨¡çµ„åŒ¯å…¥å¤±æ•—: {e}')
            print('å˜—è©¦ä½¿ç”¨åŸºæœ¬åˆ†ææ¨¡çµ„...')
            try:
                import stock_bot
                stock_bot.run_analysis('$RUN_TYPE')
                print('âœ… ä½¿ç”¨åŸºæœ¬æ¨¡çµ„åˆ†æå®Œæˆ')
            except Exception as e2:
                print(f'âŒ åŸºæœ¬æ¨¡çµ„ä¹Ÿå¤±æ•—: {e2}')
                traceback.print_exc()
                sys.exit(1)
                
        except Exception as e:
            print(f'âŒ åˆ†æåŸ·è¡Œå¤±æ•—: {e}')
            traceback.print_exc()
            sys.exit(1)
        "
        
    - name: æª¢æŸ¥åˆ†æçµæœ
      if: always()
      run: |
        echo "=== æª¢æŸ¥åˆ†æçµæœ ==="
        
        # æª¢æŸ¥æ—¥èªŒæª”æ¡ˆ
        if [ -f "logs/stock_bot.log" ]; then
          echo "ğŸ“‹ æœ€æ–°åˆ†ææ—¥èªŒ (æœ€å¾Œ20è¡Œ)ï¼š"
          echo "----------------------------------------"
          tail -20 logs/stock_bot.log
          echo "----------------------------------------"
        else
          echo "âš ï¸ æœªæ‰¾åˆ°ä¸»è¦æ—¥èªŒæª”æ¡ˆ"
        fi
        
        # æª¢æŸ¥é€šçŸ¥ç‹€æ…‹
        if [ -f "cache/notifier_status.json" ]; then
          echo "ğŸ“§ é€šçŸ¥ç³»çµ±ç‹€æ…‹ï¼š"
          cat cache/notifier_status.json | python -m json.tool
        else
          echo "âš ï¸ æœªæ‰¾åˆ°é€šçŸ¥ç‹€æ…‹æª”æ¡ˆ"
        fi
        
        # æª¢æŸ¥åˆ†æçµæœç›®éŒ„
        if [ -d "data/analysis_results" ]; then
          echo "ğŸ“Š åˆ†æçµæœæª”æ¡ˆï¼š"
          find data/analysis_results -name "*.json" -type f -exec basename {} \; | sort
        else
          echo "âš ï¸ æœªæ‰¾åˆ°åˆ†æçµæœç›®éŒ„"
        fi
        
    - name: ä¸Šå‚³åŸ·è¡Œçµæœ
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: taiwan-stock-analysis-${{ github.event.inputs.run_type || 'morning_scan' }}-${{ github.run_number }}
        path: |
          logs/
          data/analysis_results/
          cache/
        if-no-files-found: warn
        retention-days: 7
        
    - name: åŸ·è¡Œæ‘˜è¦å ±å‘Š
      if: always()
      run: |
        echo "ğŸ” === åŸ·è¡Œæ‘˜è¦å ±å‘Š ==="
        echo "åŸ·è¡Œæ™‚é–“: $(date)"
        echo "åˆ†æé¡å‹: ${{ github.event.inputs.run_type || 'è‡ªå‹•æ’ç¨‹' }}"
        echo "å·¥ä½œç›®éŒ„: $(pwd)"
        echo "Pythonç‰ˆæœ¬: $(python --version)"
        
        # çµ±è¨ˆåŸ·è¡Œçµæœ
        if [ -f "logs/stock_bot.log" ]; then
          echo "ğŸ“ˆ åŸ·è¡Œçµ±è¨ˆï¼š"
          echo "  - ç¸½æ—¥èªŒè¡Œæ•¸: $(wc -l < logs/stock_bot.log)"
          echo "  - éŒ¯èª¤è¨Šæ¯æ•¸: $(grep -c "ERROR" logs/stock_bot.log || echo 0)"
          echo "  - è­¦å‘Šè¨Šæ¯æ•¸: $(grep -c "WARNING" logs/stock_bot.log || echo 0)"
          echo "  - æˆåŠŸè¨Šæ¯æ•¸: $(grep -c "INFO" logs/stock_bot.log || echo 0)"
        fi
        
        echo "âœ… æ‘˜è¦å ±å‘Šå®Œæˆ"
