# .github/workflows/taiwan_stock_auto_push.yml
# å°è‚¡åˆ†æç³»çµ±è‡ªå‹•æ¨æ’­å·¥ä½œæµç¨‹
# æ”¯æ´å¤šæ™‚æ®µåˆ†æã€EMAIL/LINEæ¨æ’­ã€å¿ƒè·³æª¢æ¸¬

name: ğŸ‡¹ğŸ‡¼ å°è‚¡è‡ªå‹•åˆ†ææ¨æ’­ç³»çµ±

on:
  # å®šæ™‚è§¸ç™¼ (ä½¿ç”¨ UTC æ™‚é–“ï¼Œå°ç£æ™‚é–“éœ€ -8 å°æ™‚)
  schedule:
    # å¿ƒè·³æª¢æ¸¬: æ¯æ—¥ 00:30 UTC (å°ç£æ™‚é–“ 08:30)
    - cron: '30 0 * * 1-5'
    # æ—©ç›¤æƒæ: æ¯æ—¥ 01:30 UTC (å°ç£æ™‚é–“ 09:30)
    - cron: '30 1 * * 1-5'
    # ç›¤ä¸­æƒæ: æ¯æ—¥ 02:30 UTC (å°ç£æ™‚é–“ 10:30)
    - cron: '30 2 * * 1-5'
    # åˆé–“æƒæ: æ¯æ—¥ 04:30 UTC (å°ç£æ™‚é–“ 12:30)
    - cron: '30 4 * * 1-5'
    # ç›¤å¾Œæƒæ: æ¯æ—¥ 07:00 UTC (å°ç£æ™‚é–“ 15:00)
    - cron: '0 7 * * 1-5'
    # é€±æœ«ç¸½çµ: é€±å…­ 04:00 UTC (å°ç£æ™‚é–“é€±å…­ 12:00)
    - cron: '0 4 * * 6'
  
  # æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      analysis_mode:
        description: 'åˆ†ææ¨¡å¼'
        required: true
        default: 'optimized'
        type: choice
        options:
        - basic
        - enhanced
        - optimized
      time_slot:
        description: 'åˆ†ææ™‚æ®µ'
        required: true
        default: 'afternoon_scan'
        type: choice
        options:
        - morning_scan
        - mid_morning_scan
        - mid_day_scan
        - afternoon_scan
        - weekly_summary
        - heartbeat
      force_notification:
        description: 'å¼·åˆ¶ç™¼é€é€šçŸ¥'
        required: false
        default: true
        type: boolean

# ç’°å¢ƒè®Šæ•¸
env:
  PYTHONPATH: ${{ github.workspace }}
  TZ: Asia/Taipei

jobs:
  # ç³»çµ±ç‹€æ…‹æª¢æŸ¥
  system_check:
    name: ğŸ” ç³»çµ±ç‹€æ…‹æª¢æŸ¥
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      analysis_mode: ${{ steps.check.outputs.analysis_mode }}
      time_slot: ${{ steps.check.outputs.time_slot }}
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
    
    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸ” ç³»çµ±æª¢æŸ¥
      id: check
      run: |
        python << 'EOF'
        import os
        from datetime import datetime
        import pytz
        
        # ç²å–å°ç£æ™‚é–“
        taiwan_tz = pytz.timezone('Asia/Taipei')
        now = datetime.now(taiwan_tz)
        hour = now.hour
        weekday = now.weekday()  # 0=Monday, 6=Sunday
        
        # åˆ¤æ–·æ™‚æ®µå’Œæ¨¡å¼
        if "${{ github.event_name }}" == "workflow_dispatch":
            time_slot = "${{ github.event.inputs.time_slot }}"
            analysis_mode = "${{ github.event.inputs.analysis_mode }}"
            should_run = "true"
        else:
            # æ ¹æ“šç•¶å‰æ™‚é–“è‡ªå‹•åˆ¤æ–·
            if hour == 8 and 30 <= now.minute < 45:
                time_slot = "heartbeat"
                analysis_mode = "basic"
            elif hour == 9 and 30 <= now.minute < 45:
                time_slot = "morning_scan"
                analysis_mode = "optimized"
            elif hour == 10 and 30 <= now.minute < 45:
                time_slot = "mid_morning_scan"
                analysis_mode = "enhanced"
            elif hour == 12 and 30 <= now.minute < 45:
                time_slot = "mid_day_scan"
                analysis_mode = "optimized"
            elif hour == 15 and 0 <= now.minute < 15:
                time_slot = "afternoon_scan"
                analysis_mode = "optimized"
            elif weekday == 5 and hour == 12 and 0 <= now.minute < 15:  # é€±å…­
                time_slot = "weekly_summary"
                analysis_mode = "optimized"
            else:
                time_slot = "skip"
                analysis_mode = "basic"
            
            should_run = "true" if time_slot != "skip" else "false"
        
        print(f"::set-output name=should_run::{should_run}")
        print(f"::set-output name=analysis_mode::{analysis_mode}")
        print(f"::set-output name=time_slot::{time_slot}")
        
        print(f"ğŸ• å°ç£æ™‚é–“: {now.strftime('%Y-%m-%d %H:%M:%S %A')}")
        print(f"ğŸ“Š åˆ†ææ¨¡å¼: {analysis_mode}")
        print(f"â° æ™‚æ®µ: {time_slot}")
        print(f"ğŸš€ æ˜¯å¦åŸ·è¡Œ: {should_run}")
        EOF

  # å¿ƒè·³æª¢æ¸¬ä»»å‹™
  heartbeat:
    name: ğŸ’“ ç³»çµ±å¿ƒè·³æª¢æ¸¬
    runs-on: ubuntu-latest
    needs: system_check
    if: needs.system_check.outputs.should_run == 'true' && needs.system_check.outputs.time_slot == 'heartbeat'
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
    
    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸ’“ åŸ·è¡Œå¿ƒè·³æª¢æ¸¬
      env:
        EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        EMAIL_RECEIVER: ${{ secrets.EMAIL_RECEIVER }}
        EMAIL_SMTP_SERVER: ${{ secrets.EMAIL_SMTP_SERVER }}
        EMAIL_SMTP_PORT: ${{ secrets.EMAIL_SMTP_PORT }}
        LINE_ENABLED: ${{ secrets.LINE_ENABLED }}
        LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
        LINE_USER_ID: ${{ secrets.LINE_USER_ID }}
        LINE_GROUP_ID: ${{ secrets.LINE_GROUP_ID }}
      run: |
        python heartbeat_check.py

  # ä¸»è¦è‚¡ç¥¨åˆ†æä»»å‹™
  stock_analysis:
    name: ğŸ“Š è‚¡ç¥¨åˆ†ææ¨æ’­
    runs-on: ubuntu-latest
    needs: system_check
    if: needs.system_check.outputs.should_run == 'true' && needs.system_check.outputs.time_slot != 'heartbeat'
    
    strategy:
      fail-fast: false
      matrix:
        # ä½¿ç”¨çŸ©é™£ç­–ç•¥ä¾†æ”¯æ´ä¸åŒçš„åˆ†ææ¨¡å¼
        include:
          - mode: ${{ needs.system_check.outputs.analysis_mode }}
            slot: ${{ needs.system_check.outputs.time_slot }}
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
    
    - name: ğŸ è¨­ç½® Python ç’°å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: requirements.txt
    
    - name: ğŸ“¦ å®‰è£ Python ä¾è³´
      run: |
        pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt
        
        # æª¢æŸ¥é—œéµå¥—ä»¶
        python -c "import pandas; print('âœ… pandas installed')"
        python -c "import requests; print('âœ… requests installed')"
        python -c "import pytz; print('âœ… pytz installed')"
    
    - name: ğŸ“ å‰µå»ºå¿…è¦ç›®éŒ„
      run: |
        mkdir -p logs
        mkdir -p logs/notifications
        mkdir -p cache
        mkdir -p data
        mkdir -p data/analysis_results
        echo "âœ… ç›®éŒ„çµæ§‹å·²å‰µå»º"
    
    - name: ğŸ”§ èªæ³•æª¢æŸ¥
      run: |
        echo "ğŸ” æª¢æŸ¥é—œéµæ–‡ä»¶èªæ³•..."
        python syntax_check.py
    
    - name: ğŸ§ª ç³»çµ±æ¸¬è©¦
      run: |
        echo "ğŸ§ª åŸ·è¡Œç³»çµ±æ¸¬è©¦..."
        python -c "
        try:
            from integrated_stock_bot import IntegratedStockBot
            bot = IntegratedStockBot('${{ matrix.mode }}')
            print('âœ… æ•´åˆç³»çµ±åˆå§‹åŒ–æˆåŠŸ')
        except Exception as e:
            print(f'âš ï¸ ç³»çµ±æ¸¬è©¦è­¦å‘Š: {e}')
        "
    
    - name: ğŸ“Š åŸ·è¡Œè‚¡ç¥¨åˆ†æ
      env:
        # éƒµä»¶é…ç½®
        EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        EMAIL_RECEIVER: ${{ secrets.EMAIL_RECEIVER }}
        EMAIL_SMTP_SERVER: ${{ secrets.EMAIL_SMTP_SERVER || 'smtp.gmail.com' }}
        EMAIL_SMTP_PORT: ${{ secrets.EMAIL_SMTP_PORT || '587' }}
        EMAIL_USE_TLS: ${{ secrets.EMAIL_USE_TLS || 'True' }}
        
        # LINE é…ç½®
        LINE_ENABLED: ${{ secrets.LINE_ENABLED || 'True' }}
        LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
        LINE_USER_ID: ${{ secrets.LINE_USER_ID }}
        LINE_GROUP_ID: ${{ secrets.LINE_GROUP_ID }}
        
        # å…¶ä»–é…ç½®
        MARKET_ENVIRONMENT: ${{ secrets.MARKET_ENVIRONMENT || 'neutral' }}
        CURRENT_SEASON: ${{ secrets.CURRENT_SEASON || 'normal' }}
        STOCK_DATA_SOURCE: 'twse'
        
        # GitHub Actions æ¨™è¨˜
        GITHUB_ACTIONS: 'true'
        CI: 'true'
      
      run: |
        echo "ğŸš€ é–‹å§‹åŸ·è¡Œ ${{ matrix.mode }} æ¨¡å¼çš„ ${{ matrix.slot }} åˆ†æ..."
        
        # è¨˜éŒ„é–‹å§‹æ™‚é–“
        echo "é–‹å§‹æ™‚é–“: $(date '+%Y-%m-%d %H:%M:%S')"
        
        # åŸ·è¡Œåˆ†æ
        timeout 1800 python integrated_stock_bot.py run \
          --mode ${{ matrix.mode }} \
          --slot ${{ matrix.slot }} || {
          
          echo "âš ï¸ ä¸»è¦åˆ†æç¨‹åºåŸ·è¡Œç•°å¸¸ï¼Œå˜—è©¦å‚™ç”¨æ–¹æ¡ˆ..."
          
          # å‚™ç”¨æ–¹æ¡ˆ1: ä½¿ç”¨å„ªåŒ–ç‰ˆæ©Ÿå™¨äºº
          if [ -f "enhanced_stock_bot.py" ]; then
            echo "ğŸ”„ å˜—è©¦ä½¿ç”¨å„ªåŒ–ç‰ˆæ©Ÿå™¨äºº..."
            timeout 900 python enhanced_stock_bot.py ${{ matrix.slot }} || {
              echo "âŒ å„ªåŒ–ç‰ˆæ©Ÿå™¨äººä¹Ÿå¤±æ•—äº†"
            }
          fi
          
          # å‚™ç”¨æ–¹æ¡ˆ2: ç™¼é€éŒ¯èª¤é€šçŸ¥
          echo "ğŸ“§ ç™¼é€éŒ¯èª¤é€šçŸ¥..."
          python -c "
          try:
              import notifier
              notifier.init()
              error_msg = '''âŒ å°è‚¡åˆ†æç³»çµ±åŸ·è¡Œå¤±æ•—
              
æ™‚é–“: $(date '+%Y-%m-%d %H:%M:%S')
æ¨¡å¼: ${{ matrix.mode }}
æ™‚æ®µ: ${{ matrix.slot }}
éŒ¯èª¤: åˆ†æç¨‹åºåŸ·è¡Œè¶…æ™‚æˆ–ç•°å¸¸

è«‹æª¢æŸ¥ç³»çµ±ç‹€æ…‹ï¼Œå¯èƒ½éœ€è¦æ‰‹å‹•ä»‹å…¥ã€‚'''
              notifier.send_notification(error_msg, 'âŒ ç³»çµ±åŸ·è¡Œå¤±æ•—é€šçŸ¥')
          except Exception as e:
              print(f'é€šçŸ¥ç™¼é€å¤±æ•—: {e}')
          "
        }
        
        echo "âœ… åˆ†æå®Œæˆæ™‚é–“: $(date '+%Y-%m-%d %H:%M:%S')"
    
    - name: ğŸ“Š çµæœé©—è­‰
      run: |
        echo "ğŸ“Š é©—è­‰åˆ†æçµæœ..."
        
        # æª¢æŸ¥æ—¥èªŒæ–‡ä»¶
        if [ -f "logs/stock_bot.log" ]; then
          echo "âœ… æ—¥èªŒæ–‡ä»¶å­˜åœ¨"
          tail -10 logs/stock_bot.log
        else
          echo "âš ï¸ æœªæ‰¾åˆ°æ—¥èªŒæ–‡ä»¶"
        fi
        
        # æª¢æŸ¥åˆ†æçµæœæ–‡ä»¶
        TODAY=$(date '+%Y%m%d')
        RESULT_DIR="data/analysis_results/$TODAY"
        
        if [ -d "$RESULT_DIR" ]; then
          echo "âœ… åˆ†æçµæœç›®éŒ„å­˜åœ¨: $RESULT_DIR"
          ls -la "$RESULT_DIR"
        else
          echo "âš ï¸ æœªæ‰¾åˆ°åˆ†æçµæœç›®éŒ„"
        fi
        
        # æª¢æŸ¥é€šçŸ¥å‚™ä»½
        if [ -d "logs/notifications" ]; then
          echo "ğŸ“§ é€šçŸ¥å‚™ä»½ç›®éŒ„:"
          ls -la logs/notifications/ | tail -5
        fi
    
    - name: ğŸ“¤ ä¸Šå‚³åŸ·è¡Œçµæœ
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: analysis-results-${{ matrix.mode }}-${{ matrix.slot }}-${{ github.run_number }}
        path: |
          logs/
          data/analysis_results/
        retention-days: 7

  # ç‹€æ…‹å ±å‘Šä»»å‹™
  status_report:
    name: ğŸ“‹ åŸ·è¡Œç‹€æ…‹å ±å‘Š
    runs-on: ubuntu-latest
    needs: [system_check, heartbeat, stock_analysis]
    if: always() && needs.system_check.outputs.should_run == 'true'
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
    
    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: |
        pip install requests python-dotenv
    
    - name: ğŸ“‹ ç”Ÿæˆç‹€æ…‹å ±å‘Š
      env:
        EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        EMAIL_RECEIVER: ${{ secrets.EMAIL_RECEIVER }}
        LINE_ENABLED: ${{ secrets.LINE_ENABLED }}
        LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
        LINE_USER_ID: ${{ secrets.LINE_USER_ID }}
        HEARTBEAT_STATUS: ${{ needs.heartbeat.result }}
        ANALYSIS_STATUS: ${{ needs.stock_analysis.result }}
        ANALYSIS_MODE: ${{ needs.system_check.outputs.analysis_mode }}
        TIME_SLOT: ${{ needs.system_check.outputs.time_slot }}
        EVENT_NAME: ${{ github.event_name }}
        REPO_NAME: ${{ github.repository }}
        RUN_ID: ${{ github.run_id }}
      run: |
        python << 'EOF'
        import os
        from datetime import datetime
        import json
        
        # å¾ç’°å¢ƒè®Šæ•¸ç²å–ç‹€æ…‹
        heartbeat_status = os.getenv('HEARTBEAT_STATUS', 'skipped')
        analysis_status = os.getenv('ANALYSIS_STATUS', 'skipped')
        analysis_mode = os.getenv('ANALYSIS_MODE', 'unknown')
        time_slot = os.getenv('TIME_SLOT', 'unknown')
        event_name = os.getenv('EVENT_NAME', 'unknown')
        repo_name = os.getenv('REPO_NAME', 'unknown')
        run_id = os.getenv('RUN_ID', 'unknown')
        
        # ç”Ÿæˆå ±å‘Š
        trigger_method = "æ‰‹å‹•åŸ·è¡Œ" if event_name == "workflow_dispatch" else "å®šæ™‚åŸ·è¡Œ"
        system_status = "âœ… ç³»çµ±é‹è¡Œæ­£å¸¸" if analysis_status == "success" else "âš ï¸ ç³»çµ±åŸ·è¡Œç•°å¸¸ï¼Œè«‹æª¢æŸ¥æ—¥èªŒ"
        
        report = f"""ğŸ¤– å°è‚¡åˆ†æç³»çµ±åŸ·è¡Œå ±å‘Š
        
â° åŸ·è¡Œæ™‚é–“: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
ğŸ”§ åˆ†ææ¨¡å¼: {analysis_mode}
ğŸ“Š åˆ†ææ™‚æ®µ: {time_slot}
ğŸš€ è§¸ç™¼æ–¹å¼: {trigger_method}

ğŸ“ˆ åŸ·è¡Œçµæœ:
ğŸ’“ å¿ƒè·³æª¢æ¸¬: {heartbeat_status}
ğŸ“Š è‚¡ç¥¨åˆ†æ: {analysis_status}

ğŸ”— è©³ç´°æ—¥èªŒ: https://github.com/{repo_name}/actions/runs/{run_id}

{system_status}
        """
        
        print("ğŸ“‹ åŸ·è¡Œç‹€æ…‹å ±å‘Š:")
        print(report)
        
        # å¦‚æœæœ‰åš´é‡éŒ¯èª¤ï¼Œå˜—è©¦ç™¼é€ç·Šæ€¥é€šçŸ¥
        if analysis_status == "failure":
            try:
                import smtplib
                from email.mime.text import MIMEText
                
                email_sender = os.getenv('EMAIL_SENDER')
                email_password = os.getenv('EMAIL_PASSWORD')
                email_receiver = os.getenv('EMAIL_RECEIVER')
                
                if email_sender and email_password and email_receiver:
                    msg = MIMEText(report)
                    msg['Subject'] = "ğŸš¨ å°è‚¡åˆ†æç³»çµ±åŸ·è¡Œå¤±æ•—"
                    msg['From'] = email_sender
                    msg['To'] = email_receiver
                    
                    server = smtplib.SMTP('smtp.gmail.com', 587)
                    server.starttls()
                    server.login(email_sender, email_password)
                    server.send_message(msg)
                    server.quit()
                    print("ğŸ“§ ç·Šæ€¥é€šçŸ¥å·²ç™¼é€")
                else:
                    print("âš ï¸ éƒµä»¶é…ç½®ä¸å®Œæ•´ï¼Œç„¡æ³•ç™¼é€ç·Šæ€¥é€šçŸ¥")
            except Exception as e:
                print(f"ğŸ“§ ç·Šæ€¥é€šçŸ¥ç™¼é€å¤±æ•—: {e}")
        EOF

  # å¯é¸: éŒ¯èª¤è™•ç†å’Œé‡è©¦
  retry_on_failure:
    name: ğŸ”„ å¤±æ•—é‡è©¦æ©Ÿåˆ¶
    runs-on: ubuntu-latest
    needs: [stock_analysis]
    if: failure() && github.event_name == 'schedule'
    
    steps:
    - name: â° ç­‰å¾…é‡è©¦
      run: sleep 300  # ç­‰å¾…5åˆ†é˜
    
    - name: ğŸ”„ è§¸ç™¼é‡è©¦
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'stock-bot.yml',
            ref: 'main',
            inputs: {
              analysis_mode: 'optimized',
              time_slot: 'afternoon_scan',
              force_notification: 'true'
            }
          });
          console.log('ğŸ”„ å·²è§¸ç™¼é‡è©¦åŸ·è¡Œ');
