name: Taiwan Stock Analysis Bot - Enhanced Long-term Fundamental Analysis (Updated Schedule)

on:
  schedule:
    # æ—©ç›¤æƒæ - å°ç£æ™‚é–“ 09:30 (UTC+8) = UTC 01:30 (å»¶å¾Œä½¿ç”¨ç•¶æ—¥æ•¸æ“š)
    - cron: '30 1 * * 1-5'
    # ç›¤ä¸­æƒæ - å°ç£æ™‚é–“ 10:30 (UTC+8) = UTC 02:30  
    - cron: '30 2 * * 1-5'
    # åˆé–“æƒæ - å°ç£æ™‚é–“ 12:30 (UTC+8) = UTC 04:30
    - cron: '30 4 * * 1-5'
    # ç›¤å¾Œæƒæ - å°ç£æ™‚é–“ 15:00 (UTC+8) = UTC 07:00 (é‡é»é•·ç·šåˆ†æ)
    - cron: '0 7 * * 1-5'
    # é€±æœ«ç¸½çµ - å°ç£æ™‚é–“é€±å…­ 12:00 (UTC+8) = UTC 04:00 (æ”¹åˆ°é€±å…­ä¸­åˆ)
    - cron: '0 4 * * 6'
    # å¿ƒè·³æª¢æ¸¬ - å°ç£æ™‚é–“ 08:30 (UTC+8) = UTC 00:30
    - cron: '30 0 * * *'
  
  # æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      analysis_type:
        description: 'é¸æ“‡åˆ†æé¡å‹'
        required: true
        default: 'afternoon_scan'
        type: choice
        options:
          - morning_scan
          - mid_morning_scan
          - mid_day_scan
          - afternoon_scan
          - weekly_summary
          - test_notification
      force_optimized:
        description: 'å¼·åˆ¶ä½¿ç”¨å„ªåŒ–ç‰ˆç³»çµ±'
        required: false
        type: boolean
        default: true

env:
  # æ™‚å€è¨­å®š
  TZ: Asia/Taipei
  
  # éƒµä»¶é…ç½® (å¾ GitHub Secrets ç²å–)
  EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
  EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
  EMAIL_RECEIVER: ${{ secrets.EMAIL_RECEIVER }}
  EMAIL_SMTP_SERVER: ${{ secrets.EMAIL_SMTP_SERVER || 'smtp.gmail.com' }}
  EMAIL_SMTP_PORT: ${{ secrets.EMAIL_SMTP_PORT || '587' }}
  EMAIL_USE_TLS: 'True'
  
  # LINEé…ç½® (å¾ GitHub Secrets ç²å–)
  LINE_ENABLED: 'True'
  LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
  LINE_USER_ID: ${{ secrets.LINE_USER_ID }}
  LINE_GROUP_ID: ${{ secrets.LINE_GROUP_ID }}
  
  # å„ªåŒ–ç‰ˆç³»çµ±é…ç½®
  ENHANCED_ANALYSIS: 'True'
  LONG_TERM_FOCUS: 'True'
  
  # å¸‚å ´ç’°å¢ƒé…ç½® (å¯æ ¹æ“šå¸‚æ³èª¿æ•´)
  MARKET_ENVIRONMENT: ${{ secrets.MARKET_ENVIRONMENT || 'neutral' }}
  
  # åˆ†æé…ç½®
  USE_FUNDAMENTAL_ANALYSIS: 'True'
  USE_INSTITUTIONAL_ANALYSIS: 'True'
  
  # é€šçŸ¥é…ç½®
  NOTIFICATION_ENABLED: 'True'
  HTML_EMAIL: 'True'

jobs:
  stock-analysis:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Setup Python Environment
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: Install Dependencies
        run: |
          echo "å®‰è£å¥—ä»¶ä¾è³´..."
          pip install --upgrade pip
          pip install -r requirements.txt
          echo "å¥—ä»¶å®‰è£å®Œæˆ"
          
      - name: Setup Environment
        run: |
          echo "è¨­ç½®åŸ·è¡Œç’°å¢ƒ..."
          
          # å‰µå»ºå¿…è¦ç›®éŒ„
          mkdir -p logs cache data data/analysis_results data/analysis_results_optimized
          
          # é¡¯ç¤ºæ™‚å€è³‡è¨Š
          echo "ç•¶å‰æ™‚å€: $(date)"
          echo "å°ç£æ™‚é–“: $(TZ=Asia/Taipei date)"
          
          # æª¢æŸ¥å„ªåŒ–ç‰ˆç³»çµ±æ–‡ä»¶
          if [ -f "enhanced_stock_bot_optimized.py" ] && [ -f "optimized_notifier.py" ]; then
            echo "å„ªåŒ–ç‰ˆç³»çµ±æª”æ¡ˆå°±ç·’"
            echo "OPTIMIZED_SYSTEM_AVAILABLE=true" >> $GITHUB_ENV
          else
            echo "å„ªåŒ–ç‰ˆç³»çµ±æª”æ¡ˆä¸å­˜åœ¨ï¼Œå°‡ä½¿ç”¨æ¨™æº–ç‰ˆ"
            echo "OPTIMIZED_SYSTEM_AVAILABLE=false" >> $GITHUB_ENV
          fi
          
          # æª¢æŸ¥å¿…è¦é…ç½®
          CONFIG_VALID=true
          
          # æª¢æŸ¥éƒµä»¶é…ç½®
          if [ -z "$EMAIL_SENDER" ] || [ -z "$EMAIL_PASSWORD" ] || [ -z "$EMAIL_RECEIVER" ]; then
            echo "éƒµä»¶é…ç½®ä¸å®Œæ•´"
            CONFIG_VALID=false
          else
            echo "éƒµä»¶é…ç½®æª¢æŸ¥é€šé"
          fi
          
          # æª¢æŸ¥LINEé…ç½®
          if [ "$LINE_ENABLED" = "True" ]; then
            if [ -z "$LINE_CHANNEL_ACCESS_TOKEN" ]; then
              echo "LINE_CHANNEL_ACCESS_TOKEN æœªè¨­ç½®"
              CONFIG_VALID=false
            elif [ -z "$LINE_USER_ID" ] && [ -z "$LINE_GROUP_ID" ]; then
              echo "LINE_USER_ID æˆ– LINE_GROUP_ID è‡³å°‘è¦è¨­ç½®ä¸€å€‹"
              CONFIG_VALID=false
            else
              echo "LINEé…ç½®æª¢æŸ¥é€šé"
            fi
          fi
          
          echo "CONFIG_VALID=$CONFIG_VALID" >> $GITHUB_ENV
          
      - name: Determine Analysis Type
        run: |
          echo "æ±ºå®šåˆ†æé¡å‹..."
          
          # å¦‚æœæ˜¯æ‰‹å‹•è§¸ç™¼
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ANALYSIS_TYPE="${{ github.event.inputs.analysis_type }}"
            echo "æ‰‹å‹•è§¸ç™¼: $ANALYSIS_TYPE"
          else
            # æ ¹æ“šæ’ç¨‹æ™‚é–“æ±ºå®šåˆ†æé¡å‹
            CURRENT_HOUR=$(TZ=Asia/Taipei date +%H)
            CURRENT_DAY=$(TZ=Asia/Taipei date +%u)
            
            echo "ç•¶å‰æ™‚é–“: $(TZ=Asia/Taipei date)"
            echo "å°æ™‚: $CURRENT_HOUR, æ˜ŸæœŸ: $CURRENT_DAY, æ˜ŸæœŸå…­ä»£ç¢¼: 6"
            
            case $CURRENT_HOUR in
              01) ANALYSIS_TYPE="morning_scan" ;;       # 9:30 å°ç£æ™‚é–“
              02) ANALYSIS_TYPE="mid_morning_scan" ;;   # 10:30 å°ç£æ™‚é–“
              04) 
                if [ $CURRENT_DAY -eq 6 ]; then
                  ANALYSIS_TYPE="weekly_summary"        # é€±å…­12:00 å°ç£æ™‚é–“
                else
                  ANALYSIS_TYPE="mid_day_scan"          # å¹³æ—¥12:30 å°ç£æ™‚é–“
                fi
                ;;
              07) ANALYSIS_TYPE="afternoon_scan" ;;     # 15:00 å°ç£æ™‚é–“
              00) ANALYSIS_TYPE="heartbeat" ;;          # 8:30 å°ç£æ™‚é–“
              *) ANALYSIS_TYPE="afternoon_scan" ;;
            esac
            
            echo "è‡ªå‹•æ’ç¨‹: $ANALYSIS_TYPE"
          fi
          
          echo "ANALYSIS_TYPE=$ANALYSIS_TYPE" >> $GITHUB_ENV
          echo "å°‡åŸ·è¡Œ: $ANALYSIS_TYPE"
          
      - name: Run Optimized Stock Analysis
        if: env.OPTIMIZED_SYSTEM_AVAILABLE == 'true' && env.CONFIG_VALID == 'true'
        run: |
          echo "åŸ·è¡Œå„ªåŒ–ç‰ˆè‚¡å¸‚åˆ†æï¼ˆæ”¯æ´EMAIL + LINEé›™æ¨æ’­ï¼‰..."
          echo "åˆ†æé¡å‹: $ANALYSIS_TYPE"
          
          # é¡¯ç¤ºæ›´æ–°çš„ç‰¹è‰²
          echo "ğŸ†• æ›´æ–°å…§å®¹ï¼š"
          echo "  ğŸ“… æ—©ç›¤åˆ†æå»¶å¾Œåˆ° 9:30ï¼Œä½¿ç”¨ç•¶æ—¥å³æ™‚æ•¸æ“š"
          echo "  ğŸ“± å•Ÿç”¨LINEæ¨æ’­åŠŸèƒ½ï¼Œèˆ‡EMAILä¸¦è¡Œé‹ä½œ"
          echo "  ğŸ“Š é€±æœ«ç¸½çµæ”¹åˆ°é€±å…­ä¸­åˆ12:00"
          echo ""
          echo "å„ªåŒ–ç‰ˆç‰¹è‰²ï¼š"
          echo "  é•·ç·šæ¨è–¦åŸºæœ¬é¢æ¬Šé‡æå‡ 140%"
          echo "  æ³•äººè²·è³£æ¬Šé‡æå‡ 33%"
          echo "  æ®–åˆ©ç‡ > 2.5% å„ªå…ˆæ¨è–¦"
          echo "  EPSæˆé•· > 8% å„ªå…ˆæ¨è–¦"
          echo "  æ³•äººè²·è¶… > 5000è¬ å„ªå…ˆæ¨è–¦"
          
          # æ ¹æ“šåˆ†æé¡å‹é¡¯ç¤ºé æœŸçµæœ
          case $ANALYSIS_TYPE in
            "morning_scan")
              echo "æ—©ç›¤æƒæ (9:30): 200æ”¯è‚¡ç¥¨ï¼Œä½¿ç”¨ç•¶æ—¥æ•¸æ“šï¼Œæå‡åˆ†ææº–ç¢ºåº¦"
              ;;
            "mid_morning_scan")
              echo "ç›¤ä¸­æƒæ (10:30): 300æ”¯è‚¡ç¥¨ï¼ŒçŸ­ç·šæ¨è–¦å„ªå…ˆ"
              ;;
            "mid_day_scan")
              echo "åˆé–“æƒæ (12:30): 300æ”¯è‚¡ç¥¨ï¼Œæ··åˆåˆ†æ"
              ;;
            "afternoon_scan")
              echo "ç›¤å¾Œæƒæ (15:00): 1000æ”¯è‚¡ç¥¨ï¼Œé•·ç·šæ¨è–¦å¢åŠ è‡³4æ”¯"
              echo "é‡é»é—œæ³¨åŸºæœ¬é¢å„ªè³ªè‚¡"
              ;;
            "weekly_summary")
              echo "é€±æœ«ç¸½çµ (é€±å…­12:00): 1000æ”¯è‚¡ç¥¨ï¼Œé•·ç·šæ¨è–¦å¢åŠ è‡³5æ”¯"
              echo "æ·±åº¦æŒ–æ˜åŸºæœ¬é¢å„ªè³ªè‚¡ï¼Œæœ€ä½³é•·ç·šåˆ†ææ™‚æ®µ"
              ;;
            "heartbeat")
              echo "ç³»çµ±å¿ƒè·³æª¢æ¸¬"
              ;;
            "test_notification")
              echo "æ¸¬è©¦é€šçŸ¥åŠŸèƒ½ï¼ˆEMAIL + LINEï¼‰"
              ;;
          esac
          
          # åŸ·è¡Œåˆ†æ
          if [ "$ANALYSIS_TYPE" = "heartbeat" ]; then
            python heartbeat_check.py
          elif [ "$ANALYSIS_TYPE" = "test_notification" ]; then
            echo "æ¸¬è©¦EMAIL + LINEé›™æ¨æ’­..."
            python test_notification.py --test all
            python -c "
          import sys
          sys.path.append('.')
          from line_notifier import test_line_notification
          print('ğŸ§ª æ¸¬è©¦LINEæ¨æ’­åŠŸèƒ½')
          test_line_notification()
          "
          else
            python run_optimized_system.py run --slot $ANALYSIS_TYPE
          fi
          
      - name: Run Standard Stock Analysis
        if: env.OPTIMIZED_SYSTEM_AVAILABLE == 'false' && env.CONFIG_VALID == 'true'
        run: |
          echo "åŸ·è¡Œæ¨™æº–ç‰ˆè‚¡å¸‚åˆ†æ..."
          echo "å„ªåŒ–ç‰ˆç³»çµ±ä¸å¯ç”¨ï¼Œä½¿ç”¨æ¨™æº–ç‰ˆ"
          echo "åˆ†æé¡å‹: $ANALYSIS_TYPE"
          
          # åŸ·è¡Œæ¨™æº–ç‰ˆåˆ†æ
          if [ "$ANALYSIS_TYPE" = "heartbeat" ]; then
            python heartbeat_check.py
          elif [ "$ANALYSIS_TYPE" = "test_notification" ]; then
            python test_notification.py --test all
          else
            # ä½¿ç”¨æ¨™æº–ç‰ˆåˆ†æ
            if [ -f "enhanced_stock_bot.py" ]; then
              python enhanced_stock_bot.py $ANALYSIS_TYPE
            elif [ -f "stock_bot.py" ]; then  
              python stock_bot.py $ANALYSIS_TYPE
            else
              echo "æ‰¾ä¸åˆ°å¯åŸ·è¡Œçš„åˆ†æç¨‹å¼"
              exit 1
            fi
          fi
          
      - name: Handle Missing Configuration
        if: env.CONFIG_VALID == 'false'
        run: |
          echo "ç³»çµ±é…ç½®ä¸å®Œæ•´ï¼Œç„¡æ³•åŸ·è¡Œåˆ†æ"
          echo ""
          echo "è«‹åœ¨ GitHub Repository Settings > Secrets ä¸­è¨­å®šï¼š"
          echo "ğŸ“§ EMAILé…ç½®ï¼š"
          echo "  EMAIL_SENDER - ç™¼ä»¶äººéƒµç®±"
          echo "  EMAIL_PASSWORD - éƒµç®±æ‡‰ç”¨ç¨‹å¼å¯†ç¢¼"
          echo "  EMAIL_RECEIVER - æ”¶ä»¶äººéƒµç®±"
          echo ""
          echo "ğŸ“± LINEé…ç½®ï¼ˆæ–°å¢ï¼‰ï¼š"
          echo "  LINE_CHANNEL_ACCESS_TOKEN - LINE Boté »é“å­˜å–æ¬Šæ–"
          echo "  LINE_USER_ID - LINEç”¨æˆ¶IDï¼ˆå€‹äººæ¨æ’­ï¼‰"
          echo "  LINE_GROUP_ID - LINEç¾¤çµ„IDï¼ˆç¾¤çµ„æ¨æ’­ï¼Œå¯é¸ï¼‰"
          echo ""
          echo "Gmail ç”¨æˆ¶è«‹ä½¿ç”¨æ‡‰ç”¨ç¨‹å¼å¯†ç¢¼ï¼ˆ16ä½æ•¸ï¼‰"
          echo "LINE Bot è¨­å®šæ­¥é©Ÿï¼š"
          echo "  1. å‰å¾€ LINE Developers Console"
          echo "  2. å»ºç«‹æ–°çš„ Messaging API é »é“"
          echo "  3. å–å¾— Channel Access Token"
          echo "  4. å–å¾—ç”¨æˆ¶IDæˆ–ç¾¤çµ„ID"
          echo ""
          
          # å‰µå»ºæé†’æª”æ¡ˆ
          echo "é…ç½®ç¼ºå¤± - $(date)" > missing_config.log
          
          exit 1
          
      - name: Analysis Summary
        if: success()
        run: |
          echo "åˆ†æåŸ·è¡Œæ‘˜è¦"
          echo "==============================================="
          echo "åŸ·è¡Œæ™‚é–“: $(TZ=Asia/Taipei date)"
          echo "åˆ†æé¡å‹: $ANALYSIS_TYPE"
          echo "ç³»çµ±ç‰ˆæœ¬: $([ "$OPTIMIZED_SYSTEM_AVAILABLE" = "true" ] && echo "å„ªåŒ–ç‰ˆï¼ˆé•·ç·šåŸºæœ¬é¢å¼·åŒ– + LINEæ¨æ’­ï¼‰" || echo "æ¨™æº–ç‰ˆ")"
          
          # æª¢æŸ¥é€šçŸ¥ç‹€æ…‹
          if [ "$CONFIG_VALID" = "true" ]; then
            echo "ğŸ“§ EMAILé€šçŸ¥: å·²ç™¼é€"
            if [ "$LINE_ENABLED" = "True" ]; then
              echo "ğŸ“± LINEæ¨æ’­: å·²ç™¼é€"
            else
              echo "ğŸ“± LINEæ¨æ’­: æœªå•Ÿç”¨"
            fi
          else
            echo "ğŸš« é€šçŸ¥ç‹€æ…‹: é…ç½®éŒ¯èª¤"
          fi
          
          echo ""
          echo "ğŸ†• æ›´æ–°åŠŸèƒ½ï¼š"
          echo "  ğŸ“… æ—©ç›¤åˆ†ææ™‚é–“: 9:00 â†’ 9:30ï¼ˆä½¿ç”¨ç•¶æ—¥æ•¸æ“šï¼‰"
          echo "  ğŸ“± æ–°å¢LINEæ¨æ’­åŠŸèƒ½ï¼Œèˆ‡EMAILä¸¦è¡Œ"
          echo "  ğŸ“Š é€±æœ«ç¸½çµæ™‚é–“: é€±äº”17:00 â†’ é€±å…­12:00"
          
          if [ "$OPTIMIZED_SYSTEM_AVAILABLE" = "true" ]; then
            echo ""
            echo "å„ªåŒ–ç‰ˆåŠŸèƒ½å·²å•Ÿç”¨ï¼š"
            echo "  é•·ç·šæ¨è–¦åŸºæœ¬é¢åˆ†æå¼·åŒ–"
            echo "  é‡é»é—œæ³¨ï¼šæ®–åˆ©ç‡ã€EPSæˆé•·ã€æ³•äººè²·è¶…"
            echo "  æ¨è–¦æ¨™æº–ï¼šæ›´åš´æ ¼çš„åŸºæœ¬é¢ç¯©é¸"
            echo "  é›™æ¨æ’­ï¼šEMAIL + LINEåŒæ­¥é€šçŸ¥"
          fi
          
          # æ ¹æ“šåˆ†æé¡å‹é¡¯ç¤ºç‰¹è‰²
          case $ANALYSIS_TYPE in
            "morning_scan")
              echo ""
              echo "ğŸŒ… æ—©ç›¤åˆ†æç‰¹è‰²ï¼š"
              echo "  å»¶å¾Œåˆ°9:30ç¢ºä¿ç•¶æ—¥æ•¸æ“šå®Œæ•´"
              echo "  200æ”¯è‚¡ç¥¨æ·±åº¦åˆ†æ"
              echo "  æŠ€è¡“é¢å³æ™‚åæ‡‰å¸‚å ´é–‹ç›¤ç‹€æ³"
              ;;
            "afternoon_scan"|"weekly_summary")
              echo ""
              echo "é•·ç·šåˆ†æé‡é»ï¼š"
              echo "  1000æ”¯è‚¡ç¥¨æ·±åº¦åˆ†æ"
              echo "  å„ªå…ˆæ¨è–¦é«˜æ®–åˆ©ç‡è‚¡ç¥¨ï¼ˆ>2.5%ï¼‰"
              echo "  å„ªå…ˆæ¨è–¦EPSé«˜æˆé•·è‚¡ç¥¨ï¼ˆ>8%ï¼‰"
              echo "  å„ªå…ˆæ¨è–¦æ³•äººå¤§é¡è²·è¶…è‚¡ç¥¨ï¼ˆ>5000è¬ï¼‰"
              echo "  é‡è¦–ROEã€é€£çºŒé…æ¯ç­‰å“è³ªæŒ‡æ¨™"
              ;;
          esac
          
          echo "==============================================="
          echo "è‚¡å¸‚åˆ†æç³»çµ±åŸ·è¡Œå®Œæˆ"
          
      - name: Archive Analysis Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: stock-analysis-results-${{ env.ANALYSIS_TYPE }}-${{ github.run_number }}
          path: |
            logs/
            data/analysis_results*/
            *.log
          retention-days: 30
          
      - name: Workflow Status Notification
        if: failure()
        run: |
          echo "å·¥ä½œæµç¨‹åŸ·è¡Œå¤±æ•—"
          echo "åˆ†æé¡å‹: $ANALYSIS_TYPE"
          echo "å¤±æ•—æ™‚é–“: $(TZ=Asia/Taipei date)"
          echo ""
          echo "å¯èƒ½åŸå› ï¼š"
          echo "  1. EMAILæˆ–LINEé…ç½®éŒ¯èª¤"
          echo "  2. ç¶²è·¯é€£ç·šå•é¡Œ"
          echo "  3. å°è‚¡è³‡æ–™æºç•°å¸¸"
          echo "  4. ç¨‹å¼ç¢¼éŒ¯èª¤"
          echo ""
          echo "å»ºè­°æª¢æŸ¥ï¼š"
          echo "  - GitHub Secrets é€šçŸ¥è¨­å®šï¼ˆEMAIL + LINEï¼‰"
          echo "  - ç¨‹å¼ç¢¼æ˜¯å¦æ­£ç¢º"
          echo "  - åŸ·è¡Œæ—¥èªŒéŒ¯èª¤è¨Šæ¯"
