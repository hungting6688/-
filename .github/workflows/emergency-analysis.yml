name: Emergency Fast Stock Analysis

on:
  workflow_dispatch:
    inputs:
      run_type:
        description: 'é‹è¡Œé¡žåž‹'
        required: true
        default: 'morning_scan'
        type: choice
        options:
          - morning_scan
          - afternoon_scan

jobs:
  fast-analysis:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # 10åˆ†é˜è¶…æ™‚
    
    steps:
    - name: æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: è¨­ç½® Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        
    - name: å®‰è£æ ¸å¿ƒä¾è³´
      run: |
        pip install requests pandas numpy python-dotenv pytz
        
    - name: ç·Šæ€¥å¿«é€Ÿåˆ†æž
      timeout-minutes: 8
      env:
        EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        EMAIL_RECEIVER: ${{ secrets.EMAIL_RECEIVER }}
        EMAIL_SMTP_SERVER: ${{ secrets.EMAIL_SMTP_SERVER || 'smtp.gmail.com' }}
        EMAIL_SMTP_PORT: ${{ secrets.EMAIL_SMTP_PORT || '587' }}
      run: |
        RUN_TYPE="${{ github.event.inputs.run_type }}"
        echo "ðŸš€ åŸ·è¡Œç·Šæ€¥å¿«é€Ÿåˆ†æž: $RUN_TYPE"
        
        python -c "
        import sys
        import time
        from datetime import datetime
        
        print('â° é–‹å§‹æ™‚é–“:', datetime.now().strftime('%H:%M:%S'))
        
        try:
            # å¿«é€Ÿå°Žå…¥å’ŒåŸ·è¡Œ
            from twse_data_fetcher import TWStockDataFetcher
            import notifier
            
            print('âœ… æ¨¡çµ„å°Žå…¥æˆåŠŸ')
            
            # åˆå§‹åŒ–
            fetcher = TWStockDataFetcher()
            notifier.init()
            
            print('âœ… ç³»çµ±åˆå§‹åŒ–å®Œæˆ')
            
            # å¿«é€Ÿç²å–æ•¸æ“š
            print('ðŸ“Š ç²å–è‚¡ç¥¨æ•¸æ“š...')
            stocks = fetcher.get_stocks_by_time_slot('$RUN_TYPE')
            
            if not stocks:
                print('âŒ ç„¡æ³•ç²å–è‚¡ç¥¨æ•¸æ“š')
                sys.exit(1)
            
            print(f'âœ… ç²å– {len(stocks)} æ”¯è‚¡ç¥¨')
            
            # å¿«é€Ÿåˆ†æžå‰20æ”¯æœ€æ´»èºè‚¡ç¥¨
            print('ðŸ” å¿«é€Ÿåˆ†æžå‰20æ”¯æœ€æ´»èºè‚¡ç¥¨...')
            top_stocks = sorted(stocks, key=lambda x: x.get('trade_value', 0), reverse=True)[:20]
            
            short_term = []
            long_term = []
            weak_stocks = []
            
            for i, stock in enumerate(top_stocks):
                print(f'  åˆ†æž {i+1}/20: {stock[\"code\"]} {stock[\"name\"]}')
                
                # ç°¡åŒ–åˆ†æž
                score = 0
                change = stock.get('change_percent', 0)
                volume = stock.get('trade_value', 0)
                
                if change > 2: score += 2
                elif change > 0: score += 1
                elif change < -2: score -= 2
                elif change < 0: score -= 1
                
                if volume > 1000000000: score += 1
                
                # åˆ†é¡žæŽ¨è–¦
                if score >= 2 and len(short_term) < 3:
                    short_term.append({
                        'code': stock['code'],
                        'name': stock['name'],
                        'current_price': stock['close'],
                        'reason': f'ä»Šæ—¥ä¸Šæ¼² {change:.1f}%ï¼Œè¡¨ç¾å¼·å‹¢',
                        'target_price': round(stock['close'] * 1.05, 1),
                        'stop_loss': round(stock['close'] * 0.97, 1),
                        'trade_value': volume
                    })
                elif score >= 0 and len(long_term) < 2:
                    long_term.append({
                        'code': stock['code'],
                        'name': stock['name'],
                        'current_price': stock['close'],
                        'reason': 'æŠ€è¡“é¢ç©©å¥ï¼Œé©åˆä¸­é•·æœŸæŠ•è³‡',
                        'target_price': round(stock['close'] * 1.08, 1),
                        'stop_loss': round(stock['close'] * 0.95, 1),
                        'trade_value': volume
                    })
                elif score <= -2 and len(weak_stocks) < 2:
                    weak_stocks.append({
                        'code': stock['code'],
                        'name': stock['name'],
                        'current_price': stock['close'],
                        'alert_reason': f'ä»Šæ—¥ä¸‹è·Œ {abs(change):.1f}%ï¼Œéœ€æ³¨æ„é¢¨éšª',
                        'trade_value': volume
                    })
            
            print(f'ðŸ“ˆ æŽ¨è–¦çµæžœ: çŸ­ç·š {len(short_term)} æ”¯, é•·ç·š {len(long_term)} æ”¯, å¼±å‹¢ {len(weak_stocks)} æ”¯')
            
            # ç™¼é€é€šçŸ¥
            print('ðŸ“§ ç™¼é€åˆ†æžé€šçŸ¥...')
            recommendations = {
                'short_term': short_term,
                'long_term': long_term,
                'weak_stocks': weak_stocks
            }
            
            time_names = {
                'morning_scan': 'ç·Šæ€¥æ—©ç›¤åˆ†æž',
                'afternoon_scan': 'ç·Šæ€¥ç›¤å¾Œåˆ†æž'
            }
            
            display_name = time_names.get('$RUN_TYPE', 'ç·Šæ€¥è‚¡ç¥¨åˆ†æž')
            notifier.send_combined_recommendations(recommendations, display_name)
            
            end_time = datetime.now().strftime('%H:%M:%S')
            print(f'ðŸŽ‰ åˆ†æžå®Œæˆ! çµæŸæ™‚é–“: {end_time}')
            print('ðŸ“§ è«‹æª¢æŸ¥æ‚¨çš„éƒµç®±!')
            
        except Exception as e:
            print(f'âŒ åˆ†æžå¤±æ•—: {e}')
            import traceback
            traceback.print_exc()
            sys.exit(1)
        "
